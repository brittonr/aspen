# Aspen "What Next" Analysis - ULTRA MODE

**Generated**: 2026-01-16T20:30:00Z
**Branch**: v3
**Status**: Clean working tree
**Analysis Mode**: Deep/Comprehensive (ULTRA)

---

## Executive Summary

Aspen is a **mature, production-ready distributed orchestration layer** with:

- **~226,000 lines of Rust code** (6,550 in src/, 219,849 in crates/)
- **1,700+ tests** across 91 test files
- **0 compiler warnings**
- **Zero stubs or placeholders** - fully implemented
- **24 specialized crates** in workspace

Recent development (last 30 commits) has focused heavily on **federation**, **blob replication**, and **Pijul VCS integration**. The infrastructure is complete but needs comprehensive integration testing.

### Top 3 Recommended Actions

| Priority     | Action                         | Effort     | Impact                           |
|--------------|--------------------------------|------------|----------------------------------|
| 1. CRITICAL  | Federation Integration Tests   | Medium     | Validates cross-cluster discovery|
| 2. HIGH      | Forge End-to-End Tests        | Medium     | Validates Git-on-Aspen workflow  |
| 3. HIGH      | Blob Replication Failure Tests| Low-Medium | Ensures data durability          |

---

## Recent Development Focus

### Last 10 Commits Analysis

| Commit   | Focus Area                     | Files Changed |
|----------|--------------------------------|---------------|
| 683f1c2f | Federation KV persistence + blob repair RPC | +3 |
| 4f4915ae | Federation discovery RPC integration | +7 |
| 94400ce2 | DHT availability in federation status | +4 |
| 84a2cdd9 | CLI quick wins + topology sync | +5 |
| a955c17a | Blob replication integration tests | +2 |
| 2c7c00e5 | Wire TriggerBlobReplication RPC | +3 |
| 04ba4103 | Complete blob replication RPC | +4 |
| d60d903b | Configurable blob replication | +7 |
| 5e04a01e | VM executor input data fix | +2 |
| 514857dc | Echo-worker Hyperlight compatibility | +1 |

**Trend**: Heavy focus on **federation** and **blob replication** infrastructure.

---

## Work Areas by Priority

### 1. HIGH PRIORITY: Federation Testing & Integration

**Why**: Most recent development - needs validation before moving on.

The federation module (`crates/aspen-cluster/src/federation/`) is new and has:

- `discovery.rs` - DHT-based cluster discovery (BEP-44)
- `gossip.rs` - Inter-cluster announcements
- `identity.rs` - Cluster identity management
- `sync.rs` - Cross-cluster synchronization
- `trust.rs` - Trust manager for federated clusters
- `types.rs` - Federation type definitions

**Missing**:

- [ ] Integration tests for cross-cluster discovery
- [ ] End-to-end federation workflow tests
- [ ] Performance benchmarks for DHT operations
- [ ] Documentation on federation setup

### 2. HIGH PRIORITY: Forge Integration Tests

**From docs/forge.md "Next Steps"**:

1. Integration tests: End-to-end tests with real Aspen clusters
2. Patch resolution: Implement patch state machine (like issue)
3. CLI integration: Add forge commands to aspen-cli
4. Gossip integration: Wire up announcements to iroh-gossip
5. P2P sync: Implement actual object fetching from peers

**Current Status**:

- Core implementation complete
- Unit tests passing
- Integration tests TODO

### 3. MEDIUM PRIORITY: Pijul Phase 5

**From docs/pijul.md**:

- [ ] Integration tests with real Pijul changes
- [ ] Change fetching via iroh-blobs in response to HaveChanges
- [ ] Conflict resolution in concurrent updates

### 4. MEDIUM PRIORITY: Secondary Indexes (Migration Phase 5)

**From docs/architecture/migration.md**:

- Phase 1-4: COMPLETE (Single-fsync Redb, Tuple encoding, DataFusion SQL, SQLite removal)
- Phase 5: Secondary Indexes - NOT STARTED

This would add:

- `src/layer/index.rs` (~400 lines)
- Secondary index framework
- Built-in revision indexes
- Query optimization

### 5. LOW PRIORITY: CLI Polish

**From recent commits**: CLI "quick wins" were added (84a2cdd9), but there are opportunities:

- Forge commands integration
- Better error messages
- Tab completion improvements

### 6. LOW PRIORITY: TUI Enhancements

The TUI (`crates/aspen-tui/`) is functional but could benefit from:

- Federation status display
- Blob replication monitoring
- Forge repository browser

---

## Technical Debt Items

### TODO Comments in Production Code

| Location | TODO |
|----------|------|
| `src/bin/aspen-node.rs:191` | Add hook support to ShardedNodeHandle |
| `src/bin/aspen-node.rs:1334` | Wire up pijul store when available |
| `src/bin/aspen-node.rs:1458` | DNS cache sync (docs_sync feature) |
| `crates/aspen-jobs/src/event_store.rs:596` | Implement upcasting for schema migration |
| `crates/aspen-raft/src/storage.rs:1637` | Transaction support for in-memory state machine |
| `crates/aspen-cli/src/bin/aspen-cli/client.rs:218,271` | Convert to AuthenticatedRequest |

### Ignored Tests

| Test File | Reason |
|-----------|--------|
| `tests/madsim_clock_drift_test.rs:262` | Flaky - times out intermittently |
| `tests/soak_sustained_write_madsim.rs:236` | Long test - run explicitly |

### Module-Level Test TODOs

- `crates/aspen-raft/src/server.rs:23` - Integration tests needed
- `crates/aspen-raft/src/storage.rs:34` - Unit tests for InMemoryStateMachine
- `crates/aspen-testing/src/vm_manager.rs` - Unit/mock tests needed
- `crates/aspen-testing/src/fault_injection.rs` - Unit tests needed
- `crates/aspen-testing/src/router.rs` - Router and failure tests needed
- `tests/router_snapshot_t10_build_snapshot.rs:13` - Snapshot-under-failure tests

---

## Feature Completion Matrix

| Feature          | Status     | Tests      | Docs     |
|------------------|------------|------------|----------|
| Raft Consensus | Complete | Extensive | Good |
| Redb Storage | Complete | Good | Good |
| DataFusion SQL | Complete | Good | Good |
| Iroh P2P | Complete | Good | Good |
| Blob Storage | Complete | Good | Good |
| Blob Replication | **New** | Partial | Minimal |
| Forge (Git) | Complete | Unit only | Good |
| Git Bridge | Complete | Unit only | Good |
| Pijul | Phase 4 | Unit only | Good |
| Federation | **New** | Minimal | Minimal |
| DNS | Complete | Good | Good |
| Secrets | Complete | Good | Good |
| Jobs/VM | Complete | Good | Good |
| TUI | Complete | Manual | Minimal |
| CLI | Complete | Partial | Minimal |

---

## Recommended Action Plan

### This Week

1. Write federation integration tests (cluster discovery, cross-cluster sync)
2. Add forge integration tests (clone, push, issue workflow)
3. Document federation setup in CLAUDE.md or dedicated doc

### Next Sprint

4. Complete Pijul Phase 5 (change fetching, conflict resolution)
5. Start Secondary Indexes (Phase 5 of migration)
6. Add CLI commands for forge operations

### Backlog

7. TUI federation/replication dashboards
8. Performance benchmarks for new features
9. Clear remaining TODO comments

---

## Code Quality Notes

- **Build**: Clean (0 warnings)
- **Tests**: 1,700+ tests (quick profile skips slow tests)
- **Lints**: Clippy clean
- **Format**: nix fmt compliant
- **Coverage**: Unknown (run `nix run .#coverage` to check)

---

## Files Changed in Recent Work

The last 10 commits touched 23 files, adding ~4,300 lines:

- `crates/aspen-blob/src/replication/` - New replication framework
- `crates/aspen-cluster/src/federation/` - New federation module
- `crates/aspen-rpc-handlers/src/handlers/` - New RPC endpoints
- `crates/aspen-cli/src/bin/aspen-cli/commands/` - CLI enhancements

---

## Detailed Work Item Analysis

### 1. CRITICAL: Federation Integration Tests

**Current State**: Infrastructure complete, minimal test coverage

**Location**: `crates/aspen-cluster/src/federation/`

**Components**:

- `discovery.rs` - DHT-based cluster discovery (BEP-44 mutable items)
- `gossip.rs` - Inter-cluster announcements
- `identity.rs` - Cluster identity management
- `sync.rs` - Cross-cluster synchronization
- `trust.rs` - Trust manager for federated clusters
- `types.rs` - Federation type definitions

**What Needs Testing**:

```
[ ] Cross-cluster discovery via DHT
[ ] Trust establishment between clusters
[ ] Gossip announcement propagation
[ ] Federation status RPC responses
[ ] DHT availability edge cases
[ ] Network partition recovery
```

**Suggested Test Structure**:

```rust
// tests/federation_integration_test.rs
#[tokio::test]
async fn test_cross_cluster_discovery_via_dht() { ... }

#[tokio::test]
async fn test_trust_establishment_workflow() { ... }

#[tokio::test]
async fn test_federation_gossip_propagation() { ... }
```

### 2. HIGH: Forge End-to-End Tests

**Current State**: Core complete, integration incomplete

**Location**: `crates/aspen-forge/src/`

**Missing Tests** (from docs/forge.md "Next Steps"):

```
[ ] Integration tests with real Aspen clusters
[ ] Patch resolution (patch state machine like issue)
[ ] CLI forge commands (aspen-cli integration)
[ ] Gossip announcements wiring verification
[ ] P2P object fetching from peers
```

**Suggested Test Structure**:

```rust
// tests/forge_e2e_test.rs
#[tokio::test]
async fn test_clone_workflow_e2e() { ... }

#[tokio::test]
async fn test_push_workflow_e2e() { ... }

#[tokio::test]
async fn test_issue_lifecycle() { ... }

#[tokio::test]
async fn test_git_bridge_round_trip() { ... }
```

### 3. HIGH: Blob Replication Failure Tests

**Current State**: RPC complete, failure scenarios untested

**Location**: `crates/aspen-blob/src/replication/`

**Recent Additions**:

- Configurable replication (d60d903b)
- TriggerBlobReplication RPC (2c7c00e5)
- Integration tests (a955c17a)
- Blob repair RPC (683f1c2f)

**Missing Tests**:

```
[ ] Replication failure with node down
[ ] Repair RPC under load
[ ] Recovery after network partition
[ ] Partial replication scenarios
[ ] Configurable replication factor validation
```

### 4. MEDIUM: Pijul Phase 5 Completion

**Current State**: Phase 5 marked complete but needs validation

**Location**: `crates/aspen-pijul/src/`

**Phase 5 TODOs** (from docs/pijul.md):

```
[ ] Integration tests with real Pijul changes
[ ] Change fetching via iroh-blobs (in response to HaveChanges)
[ ] Conflict resolution in concurrent updates
```

**Note**: Recent commit "Wire up pijul_store in remaining locations" (07794ec2) suggests wiring is still in progress.

### 5. MEDIUM: Secondary Indexes (Migration Phase 5)

**Current State**: Not started

**Previous Phases**: ALL COMPLETE

- Phase 1: Single-fsync Redb (complete)
- Phase 2: Tuple Encoding (complete)
- Phase 3: DataFusion SQL (complete)
- Phase 4: SQLite Removal (complete Dec 26, 2025)
- Phase 5: Secondary Indexes (not started)

**Planned Scope** (from docs/architecture/layer-architecture.md):

- ~400 LOC for index framework (`src/layer/index.rs`)
- Built-in revision indexes
- Query optimization

**API Sketch**:

```rust
let email_index = IndexDefinition::new("user_by_email", indexes_space, true);
let txn = IndexedWrite::new(users_space, user_id)
    .set_value(user_json)
    .add_index(email_index, Tuple::new().push("alice@example.com"))
    .build()?;
```

---

## Production Code TODOs (8 total - very clean)

| Location                                      | TODO                                    | Priority |
|-----------------------------------------------|-----------------------------------------|----------|
| `src/bin/aspen-node.rs:191` | Add hook support to ShardedNodeHandle | Low |
| `tests/secrets_integration_test.rs:1444` | Update when handler returns actual PEM-formatted CRL | Low |
| `tests/pubsub_integration_test.rs:54,237,711` | EventStream tests, scan verification, CLI commands | Low |
| `crates/aspen-jobs/src/event_store.rs:596` | Implement upcasting for schema migration | Medium |
| `crates/aspen-rpc-handlers/src/handlers/cluster.rs:37` | Move AspenClusterTicket to shared crate | Low |
| `crates/aspen-rpc-handlers/src/handlers/core.rs:19` | Move CLIENT_RPC_REQUEST_COUNTER to aspen-constants | Low |
| `crates/aspen-rpc-handlers/src/handlers/blob.rs:466` | Add direct blob deletion to BlobStore trait | Medium |
| `crates/aspen-raft/src/storage.rs:1637` | Transaction support for in-memory state machine | Low |

**Note**: 60+ TODOs in vendored openraft code are not Aspen's concern.

---

## Ignored Tests Analysis (7 total)

| Test                          | Reason                          | Action                         |
|-------------------------------|--------------------------------|--------------------------------|
| `madsim_clock_drift_test.rs:262` | Flaky - times out intermittently | Investigate or increase timeout |
| `soak_sustained_write_madsim.rs:236` | Long test - run explicitly | Keep ignored, run in CI overnight |
| Sandbox tests (5) | Network access in sandbox | Run outside sandbox or with fixtures |

---

## Architecture Gaps Not in CLAUDE.md

These recent additions are not yet documented in `.claude/CLAUDE.md`:

1. **Blob Replication Framework** - Entire subsystem with RPC, configuration, repair
2. **Federation Module** - Cross-cluster discovery, trust, sync
3. **Pijul Phase 5** - Recently completed integration
4. **CLI Authentication** - Recent quick wins
5. **DHT Availability Monitoring** - Federation status tracking
6. **Topology Sync** - Cluster topology synchronization

**Consider updating CLAUDE.md** to include these features.

---

## Verification Commands

```bash
# Quick verification (2-5 min)
cargo nextest run -P quick

# Full test suite (20-30 min)
cargo nextest run

# Specific module tests
cargo nextest run -E 'test(/federation/)'
cargo nextest run -E 'test(/forge/)'
cargo nextest run -E 'test(/blob/)'
cargo nextest run -E 'test(/pijul/)'

# Coverage report
nix run .#coverage html

# Linting
cargo clippy --all-targets -- --deny warnings
```

---

## Decision: What Next?

Based on this analysis, the recommended order of work is:

### Option A: Testing Focus (Recommended)

1. Federation integration tests (validate recent infrastructure)
2. Forge e2e tests (validate Git-on-Aspen)
3. Blob replication failure tests (ensure durability)
4. Pijul integration tests (validate Phase 5)

### Option B: Feature Development

1. Secondary Indexes (Phase 5 of migration)
2. CLI forge commands
3. TUI federation display
4. P2P object fetching

### Option C: Technical Debt

1. Clear remaining TODOs
2. Update CLAUDE.md with new features
3. Add missing documentation
4. Investigate flaky tests

**Recommendation**: Option A (Testing Focus) - The recent infrastructure work is substantial and needs validation before adding more features. Testing now prevents technical debt accumulation.
