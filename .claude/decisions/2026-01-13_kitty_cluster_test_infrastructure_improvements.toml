# Kitty Cluster Test Infrastructure Improvements
# Decision timestamp: 2026-01-13T17:15:00Z

[summary]
title = "Comprehensive test infrastructure improvements for kitty cluster tests"
status = "implemented"
impact = "high"

[context]
problem = """
The kitty cluster test infrastructure had several architectural issues:
1. All timeout values were hardcoded, making tests inflexible for different environments
2. Wait functions used inconsistent polling strategies (some fixed interval, some exponential backoff)
3. No diagnostic logging when waits failed, making debugging difficult
4. Placeholder hash fallbacks masked real extraction failures
5. Missing subsystem wait handlers for blob, job, sql
6. Extraction helpers didn't match actual CLI output formats
"""

[solution]
approach = """
Complete overhaul of cluster-common.sh with:
1. All timeout values configurable via ASPEN_* environment variables
2. Consistent exponential backoff with configurable parameters across ALL wait functions
3. Three-tier diagnostic logging (diagnostic, warning, error)
4. Hard failures on extraction instead of placeholder fallbacks
5. Seven subsystem wait handlers (hooks, secrets, forge, dns, blob, job, sql)
6. Fixed extraction helpers for counter/sequence bare number output
"""

[implementation]

[implementation.environment_variables]
description = "Configurable timeouts and backoff parameters"
variables = [
    "ASPEN_RPC_TIMEOUT=30000 (ms) - Timeout for RPC operations",
    "ASPEN_CLUSTER_STABLE_TIMEOUT=60 (s) - Timeout for cluster stabilization",
    "ASPEN_SUBSYSTEM_TIMEOUT=90 (s) - Timeout for subsystem initialization",
    "ASPEN_CONDITION_TIMEOUT=30 (s) - Timeout for condition waits",
    "ASPEN_BACKOFF_INITIAL=1 (s) - Initial backoff delay",
    "ASPEN_BACKOFF_MAX=8 (s) - Maximum backoff delay",
    "ASPEN_BACKOFF_MULTIPLIER=2 - Backoff multiplier",
    "ASPEN_POLL_INTERVAL=2 (s) - Poll interval for fixed-interval waits",
    "ASPEN_WAIT_VERBOSE=0 - Enable diagnostic logging (set to 1 or true)"
]

[implementation.exponential_backoff]
description = "Consistent backoff across all wait functions"
functions = [
    "wait_for_cluster_stable() - Now uses exponential backoff",
    "wait_for_all_nodes_ready() - Now uses exponential backoff",
    "wait_for_subsystem() - Already used exponential backoff, now consistent",
    "retry_with_backoff() - Uses configurable parameters",
    "wait_with_backoff() - New generic helper function"
]

[implementation.diagnostic_logging]
description = "Three-tier logging for debugging wait failures"
functions = [
    "log_wait_diagnostic() - Verbose output when ASPEN_WAIT_VERBOSE=1",
    "log_wait_warning() - Always shown warnings",
    "log_wait_error() - Always shown errors with context"
]
features = [
    "Attempt counting for each wait operation",
    "Elapsed time tracking",
    "Last error message capture for subsystem waits",
    "Node-specific failure reporting in wait_for_all_nodes_ready()",
    "print_wait_config() function to display current configuration"
]

[implementation.subsystem_checks]
description = "Internal helper for consistent error capture"
details = """
New _check_subsystem() internal function:
- Captures error output in _SUBSYSTEM_ERROR variable
- Consistent handling across all 7 subsystem types
- Enables error message reporting on timeout
"""

[changes]
files = [
    "scripts/lib/cluster-common.sh - Complete refactoring with env vars, backoff, logging",
    "scripts/lib/extraction-helpers.sh - Fixed counter/sequence extraction, added issue/patch ID helpers",
    "scripts/kitty-forge-test.sh - Hard failure on hash extraction, retry logic",
    "scripts/kitty-collab-test.sh - Hard failure on ID extraction, retry logic",
    "scripts/kitty-cli-test.sh - Retry logic for transient errors",
    "scripts/kitty-hooks-test.sh - Retry logic for transient errors",
    "scripts/kitty-secrets-test.sh - Fixed assertion formats, retry logic"
]
lines_changed = "+532, -139"

[testing]
validation = """
- All shell scripts pass bash -n syntax validation
- Environment variable defaults match previous behavior
- Backward compatible - scripts work without setting any env vars
"""

[usage_examples]
description = "Example usage for different environments"

[usage_examples.ci_environment]
description = "CI environment with longer timeouts"
example = """
export ASPEN_CLUSTER_STABLE_TIMEOUT=120
export ASPEN_SUBSYSTEM_TIMEOUT=180
export ASPEN_RPC_TIMEOUT=60000
./scripts/kitty-cli-test.sh
"""

[usage_examples.debugging]
description = "Enable verbose diagnostic logging"
example = """
export ASPEN_WAIT_VERBOSE=1
./scripts/kitty-secrets-test.sh 2>&1 | tee test.log
"""

[usage_examples.faster_backoff]
description = "Faster backoff for local development"
example = """
export ASPEN_BACKOFF_INITIAL=0.5
export ASPEN_BACKOFF_MAX=4
./scripts/kitty-forge-test.sh
"""

[risks]
notes = """
- Hard failures on extraction will abort tests earlier (intentional - fail fast)
- Verbose logging can be noisy - off by default
- Environment variables must be exported, not just set
"""

[future_work]
items = [
    "Consider adding per-subsystem timeout overrides",
    "Add support for ASPEN_WAIT_LOG_FILE to capture wait logs separately",
    "Consider adaptive timeouts based on cluster size"
]
