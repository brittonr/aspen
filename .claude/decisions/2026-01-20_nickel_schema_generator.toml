# Decision: Nickel Schema Generator Implementation
# Created: 2026-01-20
# Status: Implemented

[decision]
title = "Nickel Schema Generator (aspen-nickel-gen)"
date = "2026-01-20"
status = "implemented"

[context]
description = """
After implementing Nickel as Aspen's configuration language (replacing TOML),
the need arose for a tool to automatically generate Nickel contracts from Rust
struct definitions. This ensures the schema stays in sync with the Rust types
and reduces manual maintenance burden.
"""

[problem]
statement = """
Manually maintaining Nickel schema contracts that mirror Rust configuration
structs is error-prone and tedious. When fields are added, modified, or removed
from Rust types, the corresponding Nickel contracts must be updated manually.
"""

[options]
considered = [
    "JSON Schema intermediate (schemars + json-schema-to-nickel)",
    "Proc-macro derive (compile-time)",
    "Build.rs with syn parsing (build-time)",
    "Standalone CLI with syn parsing (on-demand)",
]

[selected_option]
choice = "Standalone CLI with syn parsing"
rationale = """
1. **Flexibility**: Can be run on-demand, in CI, or as part of build
2. **Simplicity**: No complex proc-macro crate structure needed
3. **Direct generation**: Generates Nickel directly without intermediate formats
4. **Debuggability**: Easy to inspect generated output and fix issues
5. **No build dependencies**: Doesn't slow down regular builds
"""

[implementation]
summary = """
Created `aspen-nickel-gen` crate with:

1. **Parser** (parser.rs): Uses `syn` and `darling` to parse Rust source files
   - Extracts struct and enum definitions
   - Parses serde attributes (default, rename, skip, flatten)
   - Extracts doc comments
   - Identifies field types including Option<T>, Vec<T>, nested structs

2. **Generator** (generator.rs): Generates Nickel contract syntax
   - Enum contracts as [| 'variant1, 'variant2 |]
   - Record contracts with proper field annotations
   - Handles optional vs required fields
   - Applies serde rename_all transformations

3. **CLI** (main.rs): Command-line interface
   - Accepts multiple input files
   - Optional output file (stdout by default)
   - Filter flag for selective generation
   - Verbose mode for debugging
"""

[crates]
dependencies = [
    "syn = { version = \"2.0\", features = [\"full\", \"parsing\", \"extra-traits\"] }",
    "quote = \"1.0\"",
    "proc-macro2 = \"1.0\"",
    "darling = \"0.20\"",
    "clap = { version = \"4.5\", features = [\"derive\"] }",
    "anyhow = \"1.0\"",
    "thiserror (workspace)",
]

[usage]
examples = [
    "# Generate contracts from config.rs",
    "aspen-nickel-gen crates/aspen-cluster/src/config.rs",
    "",
    "# Generate to file with verbose output",
    "aspen-nickel-gen -v -o schema/config.ncl crates/aspen-cluster/src/config.rs",
    "",
    "# Filter to specific types",
    "aspen-nickel-gen --filter Config crates/*/src/config.rs",
]

[testing]
coverage = """
- Parser tests for struct extraction, enum parsing, optional fields, Vec fields
- Generator tests for enum contracts, struct contracts, snake_case conversion
- Integration test against actual NodeConfig (9 structs, 2 enums extracted)
"""

[limitations]
known = [
    "Default values are placeholders (0, false, [], {}) - actual values require runtime introspection",
    "Tagged enums with data (like HookHandlerType) need special handling",
    "External types (BatchConfig, HooksConfig) referenced by name without full definition",
    "Feature-gated fields are included without conditional compilation markers",
]

[future_work]
potential = [
    "Integration with build.rs for automatic regeneration",
    "Support for extracting actual default values via const evaluation",
    "Better handling of complex enum variants with associated data",
    "Generation of validation predicates from doc comments mentioning bounds",
]

[related_decisions]
links = [
    "2026-01-20_nickel_config_integration.md (if exists)",
]
