# =============================================================================
# Event Schema Migration (Upcasting) Implementation
# =============================================================================
# Created: 2026-01-17T00:15:00Z
# Status: COMPLETED
# Impact: Event Store - Long-running workflow evolution support
# =============================================================================

[metadata]
id = "ADR-2026-0018"
title = "Event Schema Migration (Upcasting) for Workflow Event Store"
date = "2026-01-17"
author = "Claude (ULTRA Mode)"
status = "implemented"
category = "event-sourcing"

[summary]
description = """
Implemented event schema migration (upcasting) infrastructure for the workflow
event store. This enables schema evolution for long-running workflows where
events may have been written with older schema versions.

The upcasting pattern transforms events from older schemas to the current
schema on read, ensuring backwards compatibility without requiring data
migrations.
"""

[implementation]

[implementation.core_function]
file = "crates/aspen-jobs/src/event_store.rs"
lines = "87-111"
description = """
upcast_event() function implements the upcaster pattern:
- Version 1 (current): Pass-through, no migration needed
- Version 0: Rejected (never released)
- Future versions: Rejected with upgrade message
- Unknown versions: Explicitly rejected with error
"""

[implementation.integration]
file = "crates/aspen-jobs/src/event_store.rs"
lines = "628-664"
description = """
replay_events() now applies upcasting to each event loaded from storage:
1. Deserialize raw event from JSON
2. Log if schema version differs from current
3. Call upcast_event() to migrate
4. Skip events that fail migration (with warning)
"""

[implementation.constants]
description = """
- EVENT_SCHEMA_VERSION = 1 (current version)
- _SNAPSHOT_SCHEMA_VERSION = 1 (snapshot schema version)
"""

[tests]
count = 8
file = "crates/aspen-jobs/src/event_store.rs"
test_names = [
    "test_upcast_event_current_version",
    "test_upcast_event_version_0_rejected",
    "test_upcast_event_future_version_rejected",
    "test_upcast_event_unknown_version_rejected",
    "test_upcast_preserves_all_event_fields",
    "test_upcast_all_event_types",
    "test_event_schema_version_constant",
    "test_new_event_has_current_schema_version",
]

[tests.coverage]
current_version_passthrough = true
version_0_rejection = true
future_version_rejection = true
unknown_version_rejection = true
field_preservation = true
all_event_types = true  # Tests all 27 WorkflowEventType variants

[design_decisions]

[[design_decisions.items]]
decision = "Lazy upcasting on read"
rationale = """
Events are upcasted when read from storage, not eagerly migrated.
This avoids expensive bulk migrations and allows gradual rollout.
"""

[[design_decisions.items]]
decision = "Reject unknown versions"
rationale = """
Unknown versions are rejected rather than silently corrupted.
Tiger Style: fail fast on programmer errors.
"""

[[design_decisions.items]]
decision = "Skip failed events with warning"
rationale = """
During replay, events that fail upcasting are skipped (logged at WARN level)
rather than failing the entire replay. This allows partial recovery.
"""

[[design_decisions.items]]
decision = "Explicit version matching"
rationale = """
Each version has an explicit match arm rather than range patterns.
This makes migrations auditable and prevents accidental pass-through.
"""

[tiger_style_compliance]
deterministic = true  # Upcasting is pure and side-effect free
bounded = true  # No loops or unbounded operations
explicit_errors = true  # All error paths return explicit messages
fail_fast = true  # Unknown versions fail immediately

[future_work]
description = """
When EVENT_SCHEMA_VERSION is incremented to 2, add a new match arm:

```rust
2 => Ok(event), // Current version

1 => {
    // Migrate v1 -> v2
    let mut migrated = event;
    migrated.schema_version = 2;
    // Transform fields as needed
    Ok(migrated)
}
```

The infrastructure is ready for future schema evolution.
"""

[additional_fixes]
description = """
Fixed deprecated API usage in deterministic_replay.rs example:
- Updated JobReplaySystem::new() to take node_id parameter
- Updated record_* methods to not take timestamp (HLC handles this)
- Updated DeterministicJobExecutor::new() to take node_id parameter
- Updated ReplayRunner::new() to take node_id parameter
- Updated JobReplaySystem::load() to take node_id parameter
"""

[verification]
tests_passed = true
test_count = 13  # Total event_store tests
examples_compile = true
clippy_clean = true

[commands]
run_tests = "cargo nextest run -p aspen-jobs --lib event_store"
build_examples = "cargo build -p aspen-jobs --examples"
