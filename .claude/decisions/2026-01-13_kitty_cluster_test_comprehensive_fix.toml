# Kitty Cluster Test Suite Comprehensive Fix
# Decision timestamp: 2026-01-13T16:45:00Z

[summary]
title = "Comprehensive fixes for kitty cluster test suite"
status = "implemented"
impact = "high"

[context]
problem = """
The kitty cluster test suite had multiple failure modes:
1. DNS subsystem wait used wrong CLI command (dns list vs dns zone list)
2. Race conditions during distributed cluster initialization
3. Placeholder hash fallbacks masked real extraction failures
4. Missing subsystem wait handlers for blob, job, sql
5. Output format mismatches in extraction helpers
6. Test assertions expected JSON format but CLI outputs human format
"""

[analysis]
root_causes = """
1. DNS Command Mismatch: wait_for_subsystem used 'dns list' but CLI has 'dns zone list'
2. Race Conditions: CLI requests arrive before cluster nodes fully initialize
3. Silent Failures: Tests used zero-hash placeholders when extraction failed, continuing with invalid IDs
4. Missing Handlers: No wait handlers for blob, job, sql subsystems
5. Format Mismatches: extraction-helpers expected 'Counter value: N' but CLI outputs just 'N'
"""

[solution]
approach = """
Multi-pronged fix addressing all failure modes:
1. Fixed DNS command in cluster-common.sh
2. Added retry logic with exponential backoff to all test scripts' run_cli()
3. Replaced placeholder hash fallbacks with hard failures (exit 1)
4. Added wait handlers for blob, job, sql subsystems
5. Fixed counter/sequence extraction helpers for bare number output
6. Updated test assertions to match human format output
7. Added --json flag to issue/patch creation for reliable ID extraction
"""

[changes]
files_modified = [
    "scripts/lib/cluster-common.sh",
    "scripts/lib/extraction-helpers.sh",
    "scripts/kitty-cli-test.sh",
    "scripts/kitty-forge-test.sh",
    "scripts/kitty-collab-test.sh",
    "scripts/kitty-secrets-test.sh",
    "scripts/kitty-hooks-test.sh"
]

[changes.cluster_common]
description = "Subsystem wait infrastructure improvements"
details = """
- Fixed DNS wait: 'dns list' -> 'dns zone list'
- Added wait handlers for: blob, job, sql subsystems
- All handlers use exponential backoff (1s initial, 8s max)
"""

[changes.extraction_helpers]
description = "Output format extraction fixes"
details = """
- Added extract_issue_id() for 64-char hex IDs (prefers JSON)
- Added extract_patch_id() for 64-char hex IDs (prefers JSON)
- Fixed extract_counter_value() for bare number output
- Fixed extract_sequence_value() for bare number output
"""

[changes.test_scripts]
description = "Test script robustness improvements"
details = """
- All scripts: Added retry logic to run_cli() with exponential backoff
- Retries on: NOT_INITIALIZED, cluster not initialized, subsystem not ready
- kitty-forge-test.sh: Hard failure on repo/blob/tree/commit hash extraction failure
- kitty-collab-test.sh: Hard failure on issue/patch ID extraction failure
- kitty-secrets-test.sh: Fixed assertion format (JSON -> human format)
"""

[testing]
validation = """
- All shell scripts pass bash -n syntax validation
- Project builds successfully with cargo build --release
- Changes ready for integration testing
"""

[risks]
notes = """
- Hard failures on extraction will abort test runs earlier, which is intentional
- Some tests may need longer timeouts in heavily loaded CI environments
- Consider making timeouts configurable via environment variables (future work)
"""

[future_work]
items = [
    "Add configurable timeouts via ASPEN_* environment variables",
    "Consider consistent exponential backoff across all wait functions",
    "Add diagnostic logging for failed subsystem waits",
    "Validate placeholder usage across all test scripts"
]
