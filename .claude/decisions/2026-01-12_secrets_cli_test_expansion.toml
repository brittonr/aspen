# Secrets CLI Test Expansion
# Created: 2026-01-12
# Type: Testing Enhancement

[summary]
title = "Comprehensive Secrets CLI Test Integration"
date = "2026-01-12"
type = "test_expansion"
impact = "high"

[context]
request = "Add comprehensive kitty cluster + real CLI tests for secrets"
finding = "kitty-secrets-test.sh already existed with ~72 tests, but not integrated into main CLI test suite"
approach = "Both - integrate into kitty-cli-test.sh AND expand kitty-secrets-test.sh"

# ==============================================================================
# CHANGES MADE
# ==============================================================================

[changes.kitty_cli_test]
file = "scripts/kitty-cli-test.sh"
description = "Added 'secrets' category with 17 smoke tests"
location = "Lines 1025-1105 (after SQL, before HOOKS)"

[changes.kitty_cli_test.tests_added]
kv_operations = [
    "secrets kv put",
    "secrets kv get",
    "secrets kv list",
    "secrets kv metadata",
    "secrets kv put (v2)",
    "secrets kv delete",
    "secrets kv undelete",
]
transit_operations = [
    "secrets transit create-key",
    "secrets transit encrypt",
    "secrets transit decrypt",
    "secrets transit list-keys",
    "secrets transit rotate-key",
    "secrets transit datakey",
]
pki_operations = [
    "secrets pki generate-root",
    "secrets pki create-role",
    "secrets pki issue",
    "secrets pki list-roles",
    "secrets pki list-certs",
]

[changes.kitty_secrets_test]
file = "scripts/kitty-secrets-test.sh"
description = "Added 5 new test categories and expanded error handling"

[changes.kitty_secrets_test.new_categories]
mount = "Custom mount point tests (8 tests)"
convergent = "Convergent encryption with context (5 tests)"
edge = "Edge case tests - minimal data, deep paths, special chars, versions (10 tests)"
metadata = "Multi-version metadata lifecycle tests (10 tests)"
chain = "PKI certificate chain tests (9 tests)"

[changes.kitty_secrets_test.expanded_errors]
description = "Added 8 new error handling tests"
new_tests = [
    "kv get (invalid version number)",
    "kv destroy (no versions)",
    "kv put (CAS conflict - wrong version)",
    "transit sign (encryption key)",
    "transit verify (non-existent key)",
    "transit datakey (non-existent key)",
    "pki get-role (non-existent)",
    "pki issue (unauthorized domain)",
]

# ==============================================================================
# TEST COUNT SUMMARY
# ==============================================================================

[test_counts]
kitty_cli_test_before = 0
kitty_cli_test_after = 17
kitty_cli_test_delta = 17

kitty_secrets_test_before = 72
kitty_secrets_test_after = 118
kitty_secrets_test_delta = 46

total_before = 72
total_after = 135
total_delta = 63

# ==============================================================================
# VERIFICATION
# ==============================================================================

[verification]
commands = [
    "./scripts/kitty-cli-test.sh --category secrets",
    "./scripts/kitty-secrets-test.sh",
    "./scripts/kitty-secrets-test.sh --category mount",
    "./scripts/kitty-secrets-test.sh --category convergent",
    "./scripts/kitty-secrets-test.sh --category edge",
    "./scripts/kitty-secrets-test.sh --category metadata",
    "./scripts/kitty-secrets-test.sh --category chain",
]

# ==============================================================================
# FILES MODIFIED
# ==============================================================================

[files_modified]
scripts = [
    "scripts/kitty-cli-test.sh",
    "scripts/kitty-secrets-test.sh",
]

# ==============================================================================
# CATEGORIES DOCUMENTATION
# ==============================================================================

[categories.kitty_cli_test]
list = [
    "cluster", "kv", "counter", "sequence", "lock", "semaphore", "lease",
    "barrier", "rwlock", "ratelimit", "queue", "service", "docs", "blob",
    "job", "dns", "sql", "secrets", "hooks", "verify", "federation", "peer"
]

[categories.kitty_secrets_test]
list = [
    "kv", "transit", "pki", "workflow", "errors", "json",
    "mount", "convergent", "edge", "metadata", "chain"
]
