[profile.default]
retries = 1
fail-fast = true
test-threads = 1
# Increased timeout to 60s for chaos tests that simulate network delays and leader elections
slow-timeout = { period = "60s", terminate-after = 1 }

# Fast iteration profile - skips slow tests (proptest, chaos, multi-seed madsim)
# Usage: cargo nextest run -P quick
[profile.quick]
test-threads = 1
fail-fast = true
# Excludes slow tests: proptest, chaos, madsim_multi, crash recovery, buggify, subprocess tests, job_integration, failure_cascade, and new simulation tests
# Note: For binary tests, use binary() to match the test binary name
default-filter = "not test(/proptest/) and not test(/chaos/) and not test(/madsim_multi/) and not test(/multiple_crash/) and not test(/buggify/) and not test(/real_crash/) and not test(/job_integration/) and not test(/failure_cascade/) and not binary(/madsim_snapshot/) and not binary(/madsim_membership_failure/)"
slow-timeout = { period = "30s", terminate-after = 1 }

[profile.quick.junit]
path = "junit.xml"
store-success-output = false
store-failure-output = true

# Always generate JUnit XML for test runs
[profile.default.junit]
path = "junit.xml"
store-success-output = false
store-failure-output = true

# Profile for long-running property-based tests
[profile.ci]
retries = 1
fail-fast = false
test-threads = 1
# Extended timeout for property-based tests that run multiple iterations
slow-timeout = { period = "120s", terminate-after = 1 }

# JUnit output for CI systems
[profile.ci.junit]
path = "junit.xml"
store-success-output = false
store-failure-output = true

# Specific overrides for known long-running tests
[[profile.default.overrides]]
filter = "test(test_proptest_linearizability) | test(test_proptest_fault_recovery) | test(test_proptest_leader_safety)"
retries = 1
slow-timeout = { period = "120s", terminate-after = 1 }

# Multi-crash recovery tests: 5-node cluster with 2 crash cycles needs extended timeout
[[profile.default.overrides]]
filter = "test(test_multiple_crash_recovery)"
retries = 2
slow-timeout = { period = "120s", terminate-after = 1 }

# BUGGIFY stress tests: aggressive fault injection with recovery periods
[[profile.default.overrides]]
filter = "test(/buggify/)"
retries = 2
slow-timeout = { period = "120s", terminate-after = 1 }

# Subprocess-based crash tests: spawn cargo build/run which may take time
[[profile.default.overrides]]
filter = "test(/real_crash/)"
retries = 1
slow-timeout = { period = "180s", terminate-after = 1 }

# Job worker integration tests: multi-node job coordination
[[profile.default.overrides]]
filter = "test(/madsim_job_worker/)"
retries = 1
slow-timeout = { period = "120s", terminate-after = 1 }

# Real cluster job integration tests: requires network access
[[profile.default.overrides]]
filter = "test(/job_integration/)"
retries = 1
slow-timeout = { period = "180s", terminate-after = 1 }

# Snapshot operation tests: Extended timeout for compaction and learner catchup
[[profile.default.overrides]]
filter = "test(/madsim_snapshot/)"
retries = 2
slow-timeout = { period = "120s", terminate-after = 1 }

# Membership failure tests: Joint consensus and partition recovery can be slow
[[profile.default.overrides]]
filter = "test(/madsim_membership_failure/)"
retries = 2
slow-timeout = { period = "120s", terminate-after = 1 }

# ============================================================================
# Network Profile - For tests requiring real network access
# ============================================================================
# Usage: cargo nextest run -P network --run-ignored all
# These tests are ignored in sandboxed environments (Nix) but can run locally
# or in CI with network access.

[profile.network]
retries = 2
fail-fast = false
test-threads = 1
slow-timeout = { period = "120s", terminate-after = 1 }

[profile.network.junit]
path = "junit-network.xml"
store-success-output = false
store-failure-output = true

# Pijul multi-node tests: require P2P gossip networking
[[profile.network.overrides]]
filter = "test(/pijul_multi_node/)"
retries = 2
slow-timeout = { period = "180s", terminate-after = 1 }

# Multi-node cluster tests: require Iroh QUIC networking
[[profile.network.overrides]]
filter = "test(/multi_node_cluster/)"
retries = 2
slow-timeout = { period = "180s", terminate-after = 1 }

# Blob replication tests: require P2P blob transfer
[[profile.network.overrides]]
filter = "test(/blob_replication/)"
retries = 2
slow-timeout = { period = "120s", terminate-after = 1 }

# Integration tests with real networking
[[profile.network.overrides]]
filter = "test(/hooks_integration/) or test(/secrets_integration/) or test(/dns_integration/)"
retries = 1
slow-timeout = { period = "120s", terminate-after = 1 }

# Pijul real changes tests (new integration tests)
[[profile.network.overrides]]
filter = "test(/pijul_real_changes/)"
retries = 1
slow-timeout = { period = "60s", terminate-after = 1 }

# Large file tests
[[profile.network.overrides]]
filter = "test(/large_file/)"
retries = 0
slow-timeout = { period = "180s", terminate-after = 1 }
