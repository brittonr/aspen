name: CI

on:
  push:
    branches: [main, kameo]
  pull_request:
    branches: [main, kameo]

# Cancel in-progress runs for the same workflow + branch/PR combo
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  format-check:
    name: Format Check
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes
            accept-flake-config = true

      - name: Setup Cachix
        uses: cachix/cachix-action@v15
        with:
          name: aspen-builds
          authToken: ${{ secrets.CACHIX_AUTH_TOKEN }}

      - name: Check code formatting
        run: nix fmt -- --check .

  test:
    name: Test Suite
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes
            accept-flake-config = true

      - name: Setup Cachix
        uses: cachix/cachix-action@v15
        with:
          name: aspen-builds
          authToken: ${{ secrets.CACHIX_AUTH_TOKEN }}

      - name: Run flake checks
        id: flake-check
        run: |
          # Run flake check which includes nextest tests + storage suite
          # Use -L for detailed logs
          nix flake check -L
        continue-on-error: true

      - name: Collect simulation artifacts on failure
        if: failure() && steps.flake-check.outcome == 'failure'
        run: |
          # Collect simulation artifacts if they exist
          if [ -d docs/simulations ]; then
            mkdir -p simulation-artifacts
            cp docs/simulations/*.json simulation-artifacts/ 2>/dev/null || true
            if [ -n "$(ls -A simulation-artifacts 2>/dev/null)" ]; then
              echo "Found simulation artifacts:"
              ls -lh simulation-artifacts/
            else
              echo "No simulation artifacts found"
            fi
          else
            echo "docs/simulations directory does not exist"
          fi

      - name: Upload simulation artifacts
        if: failure() && steps.flake-check.outcome == 'failure'
        uses: actions/upload-artifact@v4
        with:
          name: simulation-artifacts-${{ github.run_id }}
          path: simulation-artifacts/
          retention-days: ${{ github.event_name == 'pull_request' && 7 || 30 }}
          if-no-files-found: ignore

      - name: Fail if tests failed
        if: steps.flake-check.outcome == 'failure'
        run: exit 1

  smoke-test:
    name: Smoke Test
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes
            accept-flake-config = true

      - name: Setup Cachix
        uses: cachix/cachix-action@v15
        with:
          name: aspen-builds
          authToken: ${{ secrets.CACHIX_AUTH_TOKEN }}

      - name: Build aspen-node binary
        run: |
          # Build the aspen-node binary using Nix
          nix develop -c cargo build --bin aspen-node
          ls -lh target/debug/aspen-node

      - name: Run Raft smoke test
        id: smoke-test
        timeout-minutes: 5
        run: |
          # Run the aspen-cluster-raft-smoke.sh script
          ./scripts/aspen-cluster-raft-smoke.sh
        continue-on-error: true

      - name: Collect logs on failure
        if: failure() && steps.smoke-test.outcome == 'failure'
        run: |
          # Collect node logs if they exist
          mkdir -p smoke-test-logs
          cp n*.log smoke-test-logs/ 2>/dev/null || true
          if [ -n "$(ls -A smoke-test-logs 2>/dev/null)" ]; then
            echo "Found smoke test logs:"
            ls -lh smoke-test-logs/
          else
            echo "No smoke test logs found"
          fi

      - name: Upload smoke test logs
        if: failure() && steps.smoke-test.outcome == 'failure'
        uses: actions/upload-artifact@v4
        with:
          name: smoke-test-logs-${{ github.run_id }}
          path: smoke-test-logs/
          retention-days: 7
          if-no-files-found: ignore

      - name: Fail if smoke test failed
        if: steps.smoke-test.outcome == 'failure'
        run: exit 1
