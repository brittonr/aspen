name: Madsim Multi-Seed Testing

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  madsim:
    name: Test with Seed ${{ matrix.seed }}
    runs-on: ubuntu-latest
    timeout-minutes: 15
    strategy:
      # Don't cancel other seeds if one fails
      fail-fast: false
      matrix:
        seed: [42, 123, 456, 789, 1024]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes
            accept-flake-config = true

      - name: Setup Cachix
        uses: cachix/cachix-action@v15
        with:
          name: aspen-builds
          authToken: ${{ secrets.CACHIX_AUTH_TOKEN }}

      - name: Run madsim test with seed ${{ matrix.seed }}
        id: madsim-test
        run: |
          # NOTE: The hiqlite_flow test currently uses a hardcoded seed (42).
          # To properly support parameterized seeds, the test needs modification to:
          # 1. Read MADSIM_TEST_SEED environment variable, OR
          # 2. Accept seed as a parameter to the test function
          #
          # For now, this runs the test multiple times to verify determinism
          # and collect artifacts, but all runs use seed 42.
          #
          # TODO: Modify tests/hiqlite_flow.rs to accept MADSIM_TEST_SEED env var

          export MADSIM_TEST_SEED=${{ matrix.seed }}
          echo "Running with MADSIM_TEST_SEED=${MADSIM_TEST_SEED}"

          # Run the hiqlite_flow simulation test
          nix develop -c cargo nextest run hiqlite_flow_simulation_tracks_transport_metrics
        continue-on-error: true

      - name: Collect simulation artifacts
        if: always()
        run: |
          # Collect all simulation artifacts (passed and failed)
          if [ -d docs/simulations ]; then
            mkdir -p simulation-artifacts-seed-${{ matrix.seed }}
            cp docs/simulations/*.json simulation-artifacts-seed-${{ matrix.seed }}/ 2>/dev/null || true
            if [ -n "$(ls -A simulation-artifacts-seed-${{ matrix.seed }} 2>/dev/null)" ]; then
              echo "Found simulation artifacts for seed ${{ matrix.seed }}:"
              ls -lh simulation-artifacts-seed-${{ matrix.seed }}/
            else
              echo "No simulation artifacts found for seed ${{ matrix.seed }}"
            fi
          else
            echo "docs/simulations directory does not exist"
          fi

      - name: Upload simulation artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: simulation-artifacts-seed-${{ matrix.seed }}
          path: simulation-artifacts-seed-${{ matrix.seed }}/
          retention-days: 14
          if-no-files-found: ignore

      - name: Report test status
        if: always()
        run: |
          if [ "${{ steps.madsim-test.outcome }}" == "success" ]; then
            echo "✅ Test passed with seed ${{ matrix.seed }}"
          else
            echo "❌ Test failed with seed ${{ matrix.seed }}"
            exit 1
          fi
