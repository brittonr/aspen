name: Madsim Multi-Seed Testing

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  madsim:
    name: Test with Seed ${{ matrix.seed }}
    runs-on: ubuntu-latest
    timeout-minutes: 20
    strategy:
      # Don't cancel other seeds if one fails - we want full coverage data
      fail-fast: false
      matrix:
        # 16 diverse seeds for comprehensive coverage
        # See MADSIM_UPGRADE_PLAN_2025-12-14.md for rationale
        seed:
          - 0                      # Edge case: zero
          - 42                     # Classic test seed
          - 123456789              # Sequential digits
          - 987654321              # Reverse sequential
          - 18446744073709551615   # u64::MAX
          - 1000000001             # Large round number
          - 314159265              # Pi digits
          - 271828182              # e digits
          - 1111111111             # Repeated digits
          - 2468101214             # Even pattern
          - 1357911131             # Odd pattern
          - 555555555              # All same digit
          - 1234512345             # Repeating pattern
          - 9876598765             # Palindromic pattern
          - 1629626496             # Random looking
          - 7777777777             # Lucky sevens
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes
            accept-flake-config = true

      - name: Setup Cachix
        uses: cachix/cachix-action@v15
        with:
          name: aspen-builds
          authToken: ${{ secrets.CACHIX_AUTH_TOKEN }}

      - name: Run madsim test with seed ${{ matrix.seed }}
        id: madsim-test
        run: |
          # Run all madsim simulation tests with the specified seed
          # These tests verify deterministic behavior across different execution orders
          echo "Running madsim tests with seed ${MADSIM_TEST_SEED}"
          echo "To reproduce locally: MADSIM_TEST_SEED=${MADSIM_TEST_SEED} cargo nextest run --filter-expr 'test(~madsim)'"

          # Run all madsim simulation tests with single thread for determinism
          nix develop -c cargo nextest run --filter-expr 'test(~madsim)' --test-threads 1
        env:
          MADSIM_TEST_SEED: ${{ matrix.seed }}
          ASPEN_TEST_SEED: ${{ matrix.seed }}
        continue-on-error: true

      - name: Collect simulation artifacts
        if: always()
        run: |
          # Collect all simulation artifacts (passed and failed)
          if [ -d docs/simulations ]; then
            mkdir -p simulation-artifacts-seed-${{ matrix.seed }}
            cp docs/simulations/*.json simulation-artifacts-seed-${{ matrix.seed }}/ 2>/dev/null || true
            if [ -n "$(ls -A simulation-artifacts-seed-${{ matrix.seed }} 2>/dev/null)" ]; then
              echo "Found simulation artifacts for seed ${{ matrix.seed }}:"
              ls -lh simulation-artifacts-seed-${{ matrix.seed }}/
            else
              echo "No simulation artifacts found for seed ${{ matrix.seed }}"
            fi
          else
            echo "docs/simulations directory does not exist"
          fi

      - name: Upload simulation artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: simulation-artifacts-seed-${{ matrix.seed }}
          path: simulation-artifacts-seed-${{ matrix.seed }}/
          retention-days: 14
          if-no-files-found: ignore

      - name: Report test status
        if: always()
        run: |
          if [ "${{ steps.madsim-test.outcome }}" == "success" ]; then
            echo "Test passed with seed ${{ matrix.seed }}"
          else
            echo "Test failed with seed ${{ matrix.seed }}"
            exit 1
          fi

  aggregate-results:
    name: Aggregate Simulation Results
    needs: madsim
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: simulation-artifacts-seed-*
          path: all-artifacts/
          merge-multiple: false

      - name: Generate summary report
        run: |
          echo "# Madsim Multi-Seed Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Seeds Tested" >> $GITHUB_STEP_SUMMARY
          echo "16 diverse seeds were tested for comprehensive coverage." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Count artifacts per seed
          echo "## Artifacts Collected" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -d all-artifacts ]; then
            for dir in all-artifacts/simulation-artifacts-seed-*; do
              if [ -d "$dir" ]; then
                seed=$(basename "$dir" | sed 's/simulation-artifacts-seed-//')
                count=$(find "$dir" -name "*.json" 2>/dev/null | wc -l)
                echo "- Seed $seed: $count artifacts" >> $GITHUB_STEP_SUMMARY
              fi
            done
          else
            echo "No artifacts directory found" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Reproduction Commands" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "To reproduce a specific seed locally:" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo 'MADSIM_TEST_SEED=<seed> cargo nextest run --filter-expr "test(~madsim)" --test-threads 1' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Upload combined artifacts
        uses: actions/upload-artifact@v4
        with:
          name: all-simulation-artifacts
          path: all-artifacts/
          retention-days: 30
          if-no-files-found: ignore
