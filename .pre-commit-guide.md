# Pre-commit Hooks Guide

This document explains how to use pre-commit hooks in the Aspen project to maintain code quality and consistency.

## What are Pre-commit Hooks?

Pre-commit hooks are automated checks that run before you commit code to Git. They help catch common issues early, ensure code formatting consistency, and enforce project standards.

## Installation

Pre-commit hooks are automatically available in the Nix development shell. To install them:

```sh
nix develop -c pre-commit install
```

This command installs git hooks for both `pre-commit` and `pre-push` stages.

## Configured Hooks

The following hooks are configured in `.pre-commit-config.yaml`:

### File Hygiene (Standard Hooks)
- **trailing-whitespace**: Removes trailing whitespace from files
- **end-of-file-fixer**: Ensures files end with a newline
- **check-yaml**: Validates YAML syntax
- **check-toml**: Validates TOML syntax (Cargo.toml, etc.)
- **check-added-large-files**: Prevents committing files larger than 1MB
- **check-merge-conflict**: Detects merge conflict markers
- **check-case-conflict**: Prevents case-insensitive filename conflicts
- **mixed-line-ending**: Ensures consistent LF line endings
- **detect-private-key**: Warns if private keys are being committed

### Nix Formatting
- **alejandra-nix**: Formats Nix code with alejandra (matches `nix fmt`)

### Rust Quality Checks
- **cargo fmt**: Validates Rust code formatting with rustfmt
- **cargo clippy**: Runs clippy linter with warnings denied
- **cargo sort**: Checks that Cargo.toml dependencies are sorted (if installed)
- **cargo deny**: Checks for security advisories and banned dependencies (if installed)

### Documentation Quality
- **markdownlint**: Lints markdown files with auto-fix enabled
- **shellcheck**: Lints shell scripts for common errors

## Usage

### Automatic Checks

Once installed, pre-commit hooks run automatically when you:

```sh
git commit
```

If any hook fails, the commit will be aborted and you'll need to fix the issues.

### Manual Checks

Run all hooks on all files:

```sh
nix develop -c pre-commit run --all-files
```

Run a specific hook:

```sh
nix develop -c pre-commit run cargo-fmt --all-files
nix develop -c pre-commit run cargo-clippy --all-files
nix develop -c pre-commit run shellcheck --all-files
```

Run hooks on staged files only:

```sh
nix develop -c pre-commit run
```

### Bypassing Hooks (Not Recommended)

In rare cases where you need to bypass hooks:

```sh
git commit --no-verify
```

**Warning**: Only use this if you understand why the hooks are failing and have a valid reason to bypass them.

## Common Issues

### Cargo clippy fails

If clippy fails, you need to fix the warnings in your Rust code:

```sh
nix develop -c cargo clippy --all-targets -- -D warnings
```

### Cargo fmt fails

Format your Rust code:

```sh
nix develop -c cargo fmt
```

Then stage the formatted files and commit again.

### Markdownlint warnings

Markdown linting is configured to auto-fix most issues. If you see warnings:

```sh
nix develop -c markdownlint --fix '**/*.md'
```

The project uses a lenient `.markdownlint.yaml` configuration that allows:
- Long lines (common in technical documentation)
- Inline HTML
- Multiple blank lines
- Bare URLs

### Pre-commit not found

Make sure you're in the Nix development shell:

```sh
nix develop
pre-commit run --all-files
```

## CI Integration

The same quality checks run in CI via `nix flake check`:

- `checks.fmt`: Validates Rust formatting
- `checks.clippy`: Runs clippy with warnings denied
- `checks.deny`: Security advisory and dependency checks
- `checks.nextest`: Runs test suite

Pre-commit hooks help catch issues locally before they fail in CI.

## Updating Hooks

To update hook repositories to their latest versions:

```sh
nix develop -c pre-commit autoupdate
```

Review the changes to `.pre-commit-config.yaml` and test thoroughly before committing.

## Configuration Files

- `.pre-commit-config.yaml`: Hook configuration
- `.markdownlint.yaml`: Markdown linting rules
- `flake.nix`: Provides pre-commit and related tools in devShell

## Best Practices

1. **Run hooks before committing**: Save time by running `pre-commit run` before `git commit`
2. **Fix issues incrementally**: Don't accumulate formatting/linting debt
3. **Keep hooks fast**: Hooks should complete in seconds, not minutes
4. **Use auto-fix when available**: Many hooks (rustfmt, markdownlint) can fix issues automatically
5. **Don't bypass hooks**: They exist to maintain code quality

## Resources

- [Pre-commit documentation](https://pre-commit.com/)
- [Pre-commit hooks repository](https://github.com/pre-commit/pre-commit-hooks)
- [Alejandra Nix formatter](https://github.com/kamadorueda/alejandra)
- [Clippy lints](https://rust-lang.github.io/rust-clippy/master/)
- [Markdownlint rules](https://github.com/DavidAnson/markdownlint/blob/main/doc/Rules.md)
