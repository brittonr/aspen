[package]
name = "aspen-testing"
version = "0.1.0"
edition = "2024"
license = "AGPL-3.0-or-later"
description = "Testing utilities for Aspen distributed systems"
authors = ["Aspen Contributors"]

[dependencies]
# Core Aspen dependencies
aspen-core = { workspace = true }

# Lightweight testing core (deterministic implementations)
aspen-testing-core = { workspace = true }

# Test fixtures and builders
aspen-testing-fixtures = { workspace = true }

# Madsim simulation testing (optional)
aspen-testing-madsim = { workspace = true, optional = true }

# Network testing utilities (optional)
aspen-testing-network = { workspace = true, optional = true }

# Extracted crates for lighter dependencies
aspen-constants = { workspace = true }
aspen-cluster-types = { workspace = true }
aspen-kv-types = { workspace = true }
aspen-traits = { workspace = true }

# Raft testing (optional - required for router module)
# Feature-gated to allow lighter builds for crates that only need deterministic mocks
aspen-raft = { workspace = true, features = ["testing"], optional = true }

# Blob, cluster, jobs dependencies (optional - required for router module)
aspen-blob = { workspace = true, optional = true }
aspen-cluster = { workspace = true, optional = true }
aspen-jobs = { workspace = true, optional = true }
aspen-coordination = { workspace = true, optional = true }

aspen-forge = { workspace = true, optional = true }
aspen-ci = { workspace = true, optional = true }

# Iroh networking dependencies
iroh = "0.95.1"
iroh-base = "0.95.1"

# Async runtime
tokio = { version = "1.48.0", features = ["rt-multi-thread", "macros", "time", "sync", "process", "io-util"] }
async-trait = "0.1"

# Simulation testing (optional, heavy dependencies)
madsim = { version = "0.2.34", features = ["macros"], optional = true }
mad-turmoil = { git = "https://github.com/s2-streamstore/mad-turmoil", rev = "ef75169ec299c4160af3052b2194b3ee5b048b0a", optional = true }

# Raft consensus (optional - required for router module)
openraft = { path = "../../../aspen-raft/openraft/openraft", features = ["serde", "type-alias"], optional = true }

# Error handling
anyhow = "1.0"
snafu = "0.8.9"
thiserror = "2.0"

# Serialization
serde = { version = "1.0", features = ["derive"] }
serde_json = "1.0"

# Utilities
rand = "0.9"
tracing = "0.1"
blake3 = { workspace = true }
hex = "0.4"
base64 = { workspace = true }
tempfile = "3.4.0"
nix = { version = "0.29", features = ["process", "signal", "net"] }
reqwest = { version = "0.12", default-features = false, features = ["json", "rustls-tls"], optional = true }
parking_lot = "0.12"


[dev-dependencies]
proptest = "1.0"

# =============================================================================
# Feature Dependency Graph
# =============================================================================
#
# This section documents the feature hierarchy to help maintainers understand
# dependencies and avoid circular dependency issues.
#
# Feature Tree (indentation = dependency):
#
#   default (no deps)
#   │
#   ├── router
#   │   └── deps: aspen-raft[testing], openraft
#   │
#   ├── simulation (requires router)
#   │   └── deps: madsim, mad-turmoil, aspen-testing-madsim
#   │
#   ├── federation
#   │   └── deps: aspen-cluster
#   │
#   ├── jobs (requires simulation)
#   │   └── deps: aspen-jobs, aspen-coordination
#   │
#   ├── network
#   │   └── deps: aspen-testing-network[vm]
#   │
#   ├── http
#   │   └── deps: reqwest
#   │
#   │
#   ├── forge
#   │   └── deps: aspen-forge
#   │
#   ├── ci (requires simulation)
#   │   └── deps: aspen-ci[nickel], aspen-forge, aspen-jobs
#   │
#   ├── sql (requires router)
#   │   └── deps: aspen-raft[sql]
#   │
#   ├── testing
#   │   └── deps: http, network
#   │
#   └── full (all features)
#
# Circular Dependency Safety:
#
# aspen-coordination has aspen-testing as a DEV-dependency only.
# This means the following chain is SAFE (no runtime circular dependency):
#
#   aspen-testing[jobs] -> aspen-jobs -> aspen-coordination
#                                              |
#                                              v (dev-dep only)
#                                        aspen-testing
#
# Dev-dependencies are NOT included in the regular dependency graph,
# so there is no circular dependency at compile time or runtime.
#
# =============================================================================

[features]
default = []

# ---------------------------------------------------------------------------
# Core Testing Features
# ---------------------------------------------------------------------------

# In-memory Raft router for unit tests.
# Heavy: pulls aspen-raft + openraft (~20+ transitive deps)
# Use case: Testing Raft consensus, KV operations, cluster membership
router = [
    "dep:aspen-raft",
    "dep:openraft",
]

# Deterministic simulation testing with madsim.
# Heavy: pulls madsim runtime and mad-turmoil network simulator
# Use case: Reproducible distributed system tests, chaos testing
# Requires: router
simulation = [
    "router",
    "dep:madsim",
    "dep:mad-turmoil",
    "dep:aspen-testing-madsim",
]

# ---------------------------------------------------------------------------
# Domain-Specific Testing Features
# ---------------------------------------------------------------------------

# Federation testing (multi-cluster scenarios).
# Use case: Testing cross-cluster communication, trust relationships
federation = [
    "dep:aspen-cluster",
    "aspen-cluster/federation",
]

# Job worker testing (distributed task execution).
# Use case: Testing job queues, worker pools, task scheduling
# Requires: simulation (for deterministic job execution tests)
jobs = [
    "simulation",
    "dep:aspen-jobs",
    "dep:aspen-coordination",
]

# CI pipeline testing.
# Use case: Testing CI/CD pipelines, Nickel configurations
# Requires: simulation (for deterministic pipeline tests)
ci = [
    "simulation",
    "dep:aspen-ci",
    "aspen-ci/nickel",
    "dep:aspen-forge",
    "dep:aspen-jobs",
]

# Forge (Git hosting) testing.
# Use case: Testing Git operations, repository management
forge = [
    "dep:aspen-forge",
]

# SQL query testing.
# Use case: Testing DataFusion SQL over KV data
# Requires: router (for Raft-backed KV storage)
sql = [
    "router",
    "aspen-raft/sql",
    "aspen-testing-madsim?/sql",
]

# ---------------------------------------------------------------------------
# Infrastructure Testing Features
# ---------------------------------------------------------------------------

# Network testing (fault injection, VM management).
# Use case: Network partition simulation, VM-based integration tests
network = [
    "dep:aspen-testing-network",
    "aspen-testing-network/vm",
]

# HTTP testing utilities.
# Use case: HTTP client testing, API integration tests
http = [
    "dep:reqwest",
]

# VM testing utilities (combines http + network).
# Use case: Full infrastructure testing with VMs
testing = [
    "http",
    "network",
]

# ---------------------------------------------------------------------------
# Meta Features
# ---------------------------------------------------------------------------

# Full test suite - enables all features.
# Use case: CI builds, comprehensive local testing
# Warning: Significantly increases compile time and binary size
full = [
    "router",
    "simulation",
    "federation",
    "jobs",
    "network",
    "ci",
    "http",
]
