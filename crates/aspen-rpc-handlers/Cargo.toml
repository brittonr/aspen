[package]
name = "aspen-rpc-handlers"
version = "0.1.0"
edition = "2024"
description = "RPC handler implementations for Aspen distributed cluster"
license = "AGPL-3.0-or-later"

[dependencies]
# RPC core abstractions (RequestHandler trait, ClientProtocolContext)
aspen-rpc-core = { path = "../aspen-rpc-core" }

# Local crates
aspen-client = { path = "../aspen-client" }
aspen-client-api = { workspace = true }
aspen-core = { path = "../aspen-core" }
aspen-ticket = { workspace = true }
aspen-coordination = { path = "../aspen-coordination" }
aspen-kv-handler = { path = "../aspen-kv-handler" }
aspen-core-essentials-handler = { path = "../aspen-core-essentials-handler" }
aspen-cluster-handler = { path = "../aspen-cluster-handler" }
aspen-blob = { path = "../aspen-blob", optional = true }
aspen-blob-handler = { path = "../aspen-blob-handler", optional = true }
aspen-dns = { path = "../aspen-dns", optional = true }
aspen-sql = { path = "../aspen-sql", optional = true }
aspen-auth = { path = "../aspen-auth" }
aspen-forge = { path = "../aspen-forge", optional = true }
aspen-forge-handler = { path = "../aspen-forge-handler", optional = true }
aspen-hooks-types = { path = "../aspen-hooks-types" }
aspen-hooks = { path = "../aspen-hooks", optional = true }
aspen-jobs = { path = "../aspen-jobs", optional = true }
aspen-raft = { path = "../aspen-raft" }
aspen-cluster = { path = "../aspen-cluster" }
aspen-transport = { path = "../aspen-transport" }
aspen-sharding = { path = "../aspen-sharding" }
aspen-docs = { path = "../aspen-docs", optional = true }
aspen-docs-handler = { path = "../aspen-docs-handler", optional = true }
aspen-secrets = { path = "../aspen-secrets", optional = true }
aspen-secrets-handler = { path = "../aspen-secrets-handler", optional = true }
aspen-ci = { path = "../aspen-ci", optional = true }
aspen-ci-handler = { path = "../aspen-ci-handler", optional = true }
aspen-nix-handler = { path = "../aspen-nix-handler", optional = true }
aspen-query-handler = { path = "../aspen-query-handler", optional = true }
aspen-hooks-handler = { path = "../aspen-hooks-handler", optional = true }
aspen-job-handler = { path = "../aspen-job-handler", optional = true }
aspen-nix-cache-gateway = { path = "../aspen-nix-cache-gateway", optional = true }
aspen-wasm-plugin = { path = "../aspen-wasm-plugin", optional = true }

# Atomic pointer swap for hot-reload of plugin handlers
arc-swap = "1.8"

# Core dependencies
tokio = { version = "1.0", features = ["rt-multi-thread", "sync", "macros"] }
tracing = "0.1"
anyhow = "1.0"
serde = { version = "1.0", features = ["derive"] }
serde_json = "1.0"
async-trait = "0.1"

# Iroh dependencies
iroh = { version = "0.95.1", features = ["metrics"] }
iroh-gossip = "0.95"

# Hash and data dependencies
blake3 = { workspace = true }
postcard = { workspace = true }

# RPC framework
irpc = { workspace = true }

[features]
default = []
sql = ["dep:aspen-sql", "dep:aspen-query-handler", "aspen-query-handler?/sql", "aspen-rpc-core/sql"]
dns = ["dep:aspen-dns", "dep:aspen-query-handler", "aspen-query-handler?/dns"]
forge = ["dep:aspen-forge", "dep:aspen-forge-handler", "aspen-rpc-core/forge"]
blob = ["dep:aspen-blob", "dep:aspen-blob-handler", "aspen-rpc-core/blob"]
global-discovery = ["aspen-core/global-discovery", "aspen-rpc-core/global-discovery"]
git-bridge = ["forge", "aspen-forge/git-bridge"]
secrets = ["dep:aspen-secrets", "dep:aspen-secrets-handler"]
automerge = ["aspen-client-api/automerge"]
ci = ["dep:aspen-ci", "dep:aspen-ci-handler", "dep:aspen-nix-handler", "aspen-nix-handler?/cache", "forge", "aspen-client-api/ci", "aspen-rpc-core/ci", "aspen-rpc-core/nickel", "aspen-ci?/nickel"]
nix-cache-gateway = ["dep:aspen-nix-cache-gateway", "secrets", "aspen-rpc-core/nix-cache-gateway"]
snix = ["dep:aspen-nix-handler", "aspen-nix-handler?/snix"]
hooks = ["dep:aspen-hooks-handler", "dep:aspen-hooks", "aspen-rpc-core/hooks"]
jobs = ["dep:aspen-jobs", "dep:aspen-job-handler", "aspen-rpc-core/jobs", "aspen-rpc-core/worker"]
docs = ["dep:aspen-docs", "dep:aspen-docs-handler", "aspen-cluster-handler/docs"]
plugins-rpc = ["dep:aspen-wasm-plugin", "blob"]
testing = []

[dev-dependencies]
aspen-testing = { workspace = true }
# Enable testing feature for test_support module
aspen-rpc-core = { path = "../aspen-rpc-core", features = ["testing"] }
proptest = "1.0"
tokio = { version = "1.0", features = ["full", "test-util"] }
bolero = { workspace = true }
bolero-generator = { workspace = true }

# Enable testing feature for integration tests (without sql/dns/blob default features)
[[test]]
name = "proptest_coordination"
required-features = ["testing"]

[[test]]
name = "proptest_kv"
required-features = ["testing"]

[[test]]
name = "stress_coordination"
required-features = ["testing"]

[[test]]
name = "stress_kv"
required-features = ["testing"]

[[test]]
name = "bolero_coordination"
required-features = ["testing"]

[[test]]
name = "bolero_kv"
required-features = ["testing"]

[[test]]
name = "unit_coordination"
required-features = ["testing"]
