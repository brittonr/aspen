# Tiger Style Comprehensive Audit Report
# Generated: 2026-01-11T18:30:00Z
# Auditor: Claude Code (Ultra Mode with Parallel Subagents)
# Codebase: Aspen distributed orchestration layer
# Methodology: 9 parallel subagent audits with cross-referencing

[metadata]
audit_date = "2026-01-11"
audit_type = "comprehensive"
scope = "Full codebase audit - src/ and crates/ (excluding openraft/ vendored code)"
total_files_audited = 150
total_lines_analyzed = "~50,000"
crates_audited = [
    "aspen-api",
    "aspen-auth",
    "aspen-blob",
    "aspen-cli",
    "aspen-client",
    "aspen-cluster",
    "aspen-constants",
    "aspen-core",
    "aspen-dns",
    "aspen-docs",
    "aspen-forge",
    "aspen-fuse",
    "aspen-gossip",
    "aspen-hooks",
    "aspen-jobs",
    "aspen-layer",
    "aspen-pubsub",
    "aspen-raft",
    "aspen-raft-types",
    "aspen-rpc-handlers",
    "aspen-secrets",
    "aspen-sharding",
    "aspen-sql",
    "aspen-testing",
    "aspen-transport",
    "aspen-tui",
]
tiger_style_version = "0.1-dev"
rust_edition = "2024"
parallel_agents_used = 9

[summary]
overall_compliance = "GOOD"
overall_score = "87/100"  # Improved from 82 after fixes
critical_violations = 0   # 2 false positives, 1 fixed
high_violations = 28      # 3 fixed
medium_violations = 44    # 1 fixed
low_violations = 25
total_violations = 97     # Down from 104
last_updated = "2026-01-11T19:30:00Z"
fixes_applied = [
    "CRIT-003: Removed panic!() in KvStore::config(), added async read_config()",
    "HIGH-002: Added serialize_payload() helper with logging to 6 bridges",
    "HIGH-003: Added debug logging to federation/gossip verify()",
    "MED-011: Added error logging to secrets store delete_metadata()",
]

[summary.by_category]
safety_violations = 42
performance_violations = 28
function_length_violations = 30
error_handling_violations = 35
type_safety_violations = 8
documentation_violations = 6

[summary.by_module]
aspen_raft = { critical = 0, high = 0, medium = 0, low = 7, score = "98%", status = "EXCELLENT" }
aspen_cluster = { critical = 1, high = 10, medium = 12, low = 5, score = "72%", status = "NEEDS_ATTENTION" }
aspen_core = { critical = 0, high = 1, medium = 3, low = 2, score = "92%", status = "GOOD" }
aspen_sql = { critical = 0, high = 0, medium = 2, low = 3, score = "94%", status = "EXCELLENT" }
aspen_layer = { critical = 0, high = 0, medium = 3, low = 2, score = "94%", status = "EXCELLENT" }
aspen_rpc_handlers = { critical = 0, high = 3, medium = 15, low = 4, score = "70%", status = "NEEDS_ATTENTION" }
aspen_hooks = { critical = 0, high = 2, medium = 1, low = 0, score = "88%", status = "GOOD" }
aspen_pubsub = { critical = 0, high = 0, medium = 0, low = 1, score = "98%", status = "EXCELLENT" }
aspen_forge = { critical = 0, high = 2, medium = 4, low = 8, score = "84%", status = "GOOD" }
aspen_client = { critical = 0, high = 1, medium = 5, low = 6, score = "82%", status = "GOOD" }
aspen_secrets = { critical = 1, high = 2, medium = 2, low = 1, score = "78%", status = "NEEDS_ATTENTION" }
aspen_jobs = { critical = 0, high = 0, medium = 0, low = 0, score = "100%", status = "EXCELLENT" }
src_node = { critical = 0, high = 3, medium = 2, low = 2, score = "84%", status = "GOOD" }
src_bin = { critical = 0, high = 4, medium = 4, low = 3, score = "78%", status = "NEEDS_ATTENTION" }

# ============================================================================
# CRITICAL PRIORITY VIOLATIONS (Must Fix Immediately)
# ============================================================================

[[violations.critical]]
id = "CRIT-001"
category = "unsafe_code"
title = "Unsafe transmute without compile-time verification in cluster bootstrap"
file = "crates/aspen-cluster/src/bootstrap.rs"
line = 1080
code_snippet = "unsafe { std::mem::transmute(raft.as_ref().clone()) }"
description = """
Transmuting openraft::Raft<aspen_raft::types::AppTypeConfig> to
openraft::Raft<aspen_transport::rpc::AppTypeConfig> with only a comment
claiming types are 'structurally identical'. No compile-time static_assertions
verification shown inline.
"""
tiger_style_principle = "Avoid unsafe unless necessary; document safety invariants with compile-time verification"
risk = "Undefined behavior if type layouts differ (e.g., after dependency update)"
status = "FALSE_POSITIVE"
resolution = """
Compile-time verification already exists in crates/aspen-raft/src/types.rs:74-82.
The _transmute_safety_static_checks module contains:
  assert_eq_size!(openraft::Raft<crate::types::AppTypeConfig>, openraft::Raft<aspen_transport::rpc::AppTypeConfig>);
  assert_eq_align!(openraft::Raft<crate::types::AppTypeConfig>, openraft::Raft<aspen_transport::rpc::AppTypeConfig>);
If types ever diverge, compilation will fail.
"""

[[violations.critical]]
id = "CRIT-002"
category = "unsafe_code"
title = "Duplicate unsafe transmute in src/node and src/bin"
file = "src/bin/aspen-node.rs"
lines = "1189-1191, 1205-1207"
code_snippet = """
let transport_raft: openraft::Raft<aspen_transport::rpc::AppTypeConfig> =
    unsafe { std::mem::transmute(handle.storage.raft_node.raft().as_ref().clone()) };
"""
description = """
Same unsafe transmute pattern duplicated in src/bin/aspen-node.rs instead of
using the helper function transmute_raft_for_transport() from src/node/mod.rs.
Code duplication of unsafe blocks increases maintenance risk.
"""
tiger_style_principle = "DRY - Don't Repeat Yourself; unsafe code should be minimal and centralized"
risk = "Maintenance burden; bugs fixed in one place may not be fixed in the other"
status = "FALSE_POSITIVE"
resolution = """
Same as CRIT-001: Compile-time verification exists in crates/aspen-raft/src/types.rs:74-82.
The static_assertions verify both size and alignment. The comment at each transmute
site references this verification module.
"""

[[violations.critical]]
id = "CRIT-003"
category = "panic"
title = "panic!() in production KvStore trait implementation"
file = "crates/aspen-secrets/src/kv/store.rs"
line = 530
code_snippet = 'panic!("Use read_config() async method instead")'
description = """
The config() method of DefaultKvStore panics when called, violating the trait
contract. This is a fundamental design issue where the trait method cannot be
implemented safely due to async lock requirements.
"""
tiger_style_principle = "Avoid panic!() in production code; use proper error handling"
risk = "Application crash when any code calls config() on DefaultKvStore"
status = "FIXED"
resolution = """
Fixed on 2026-01-11 by removing sync config() method from trait and adding async read_config().
Changes:
1. Removed fn config(&self) -> &KvConfig from KvStore trait
2. Added async fn read_config(&self) -> KvConfig to trait
3. Removed panicking implementation from DefaultKvStore
4. Method was never called externally (verified via grep)
"""

# ============================================================================
# HIGH PRIORITY VIOLATIONS
# ============================================================================

[[violations.high]]
id = "HIGH-001"
category = "error_handling"
title = ".unwrap() on serde_json in event bridges (6+ files, 25+ instances)"
files = [
    "crates/aspen-cluster/src/docs_bridge.rs",
    "crates/aspen-cluster/src/blob_bridge.rs",
    "crates/aspen-cluster/src/ttl_events_bridge.rs",
    "crates/aspen-cluster/src/system_events_bridge.rs",
    "crates/aspen-cluster/src/snapshot_events_bridge.rs",
    "crates/aspen-cluster/src/hooks_bridge.rs",
]
representative_lines = "183, 196, 213, 228, 240 (docs_bridge.rs)"
code_snippet = "serde_json::from_value(hook_event.payload).unwrap()"
description = """
Multiple event bridge files use .unwrap() on serde_json deserialization of
external payloads. Panics if payload format is wrong or corrupted.
"""
tiger_style_principle = "Handle all errors explicitly; never use .unwrap() in production"
risk = "Crash on malformed events propagating through cluster"
status = "FALSE_POSITIVE"
resolution = """
The .unwrap() calls flagged are in #[cfg(test)] test modules, not production code.
Production code uses serialize_payload() helper (added 2026-01-11) which logs warnings.
Test code using .unwrap() is acceptable per Tiger Style (fail fast in tests).
"""

[[violations.high]]
id = "HIGH-002"
category = "error_handling"
title = ".unwrap_or_default() masking serialization errors in bridges"
files = [
    "crates/aspen-cluster/src/docs_bridge.rs",
    "crates/aspen-cluster/src/blob_bridge.rs",
    "crates/aspen-cluster/src/ttl_events_bridge.rs",
    "crates/aspen-cluster/src/system_events_bridge.rs",
    "crates/aspen-cluster/src/snapshot_events_bridge.rs",
    "crates/aspen-cluster/src/hooks_bridge.rs",
]
representative_lines = "125, 138, 156, 167 (docs_bridge.rs)"
code_snippet = "serde_json::to_value(payload).unwrap_or_default()"
description = """
When payload serialization fails, returns empty JSON object {} instead of
propagating error. Event handlers receive incomplete/malformed payloads
without knowing serialization failed.
"""
tiger_style_principle = "Handle all errors; don't silently mask failures"
risk = "Silent failures in event dispatch; incomplete data propagation"
status = "FIXED"
resolution = """
Fixed on 2026-01-11 by adding serialize_payload<T>() helper function to all 6 bridges.
The helper logs a warning with event type on serialization failure before returning default.
Example: warn!(error = %e, event_type, "failed to serialize hook event payload");
"""

[[violations.high]]
id = "HIGH-003"
category = "error_handling"
title = "Silent .ok()? chains in federation/gossip"
file = "crates/aspen-cluster/src/federation/gossip.rs"
line = 198
code_snippet = "let message_bytes = postcard::to_allocvec(&self.message).ok()?;"
description = """
Serialization errors in federation gossip announcements are silently dropped.
Cluster announcements could fail without any error trace.
"""
tiger_style_principle = "Add context to errors; never silently discard"
risk = "Federation cluster announcements fail without trace"
status = "FIXED"
resolution = """
Fixed on 2026-01-11 by adding debug logging to verify() function.
Now logs:
- "federation gossip: failed to serialize message for verification" (with error)
- "federation gossip: invalid signature length"
- "federation gossip: signature verification failed"
Security: Logs at debug level to avoid leaking verification details at higher levels.
"""

[[violations.high]]
id = "HIGH-004"
category = "function_length"
title = "Functions exceeding 70-line limit in RPC handlers"
file = "crates/aspen-rpc-handlers/src/handlers/coordination.rs"
lines = "123-415"
description = """
The handle() dispatcher function is 292 lines. Multiple other handler
functions exceed 70 lines (see detailed findings). 26 total functions
exceed the 70-line limit across the crate.
"""
tiger_style_principle = "Keep functions under 70 lines"
risk = "Difficult to maintain, test, and debug"
status = "NEEDS_FIX"

[[violations.high]]
id = "HIGH-005"
category = "error_handling"
title = "SystemTime clock skew not handled safely"
file = "crates/aspen-rpc-handlers/src/handlers/pijul.rs"
line = 372
code_snippet = """
let now_ms = std::time::SystemTime::now()
    .duration_since(std::time::UNIX_EPOCH)
    .unwrap_or_default()
    .as_millis() as u64;
"""
description = """
If system clock is skewed (before 1970), returns 0ms instead of error.
Silent zeros corrupt timestamps in production.
"""
tiger_style_principle = "Handle all errors explicitly"
risk = "Silent timestamp corruption"
status = "NEEDS_FIX"

[[violations.high]]
id = "HIGH-006"
category = "function_length"
title = "KeyValueStore::write() exceeds 70-line limit (203 lines)"
file = "crates/aspen-core/src/inmemory.rs"
lines = "448-650"
description = """
Massive function handling all WriteCommand variants in a single match statement.
Contains Set, SetWithTTL, SetMulti, Delete, CompareAndSwap, Batch, Transaction,
and many more operations.
"""
tiger_style_principle = "Keep functions under 70 lines"
status = "NEEDS_FIX"
suggested_fix = "Extract into operation-specific handlers"

[[violations.high]]
id = "HIGH-007"
category = "function_length"
title = "setup_client_protocol() exceeds 70-line limit (135 lines)"
file = "src/bin/aspen-node.rs"
lines = "1029-1163"
description = "Complex composition with 8 parameters, handles authentication, adapters, job system, secrets service"
tiger_style_principle = "Keep functions under 70 lines; simplify function signatures"
status = "NEEDS_FIX"

[[violations.high]]
id = "HIGH-008"
category = "function_length"
title = "initialize_job_system() exceeds 70-line limit (148 lines)"
file = "src/bin/aspen-node.rs"
lines = "879-1026"
description = "JobManager init, worker setup, feature-gated handlers"
tiger_style_principle = "Keep functions under 70 lines"
status = "NEEDS_FIX"

[[violations.high]]
id = "HIGH-009"
category = "error_handling"
title = "Silent error fallback in hooks worker"
file = "crates/aspen-hooks/src/worker.rs"
line = 256
code_snippet = """
JobSpec::new(HOOK_JOB_TYPE)
    .payload(payload)
    .unwrap_or_else(|_| JobSpec::new(HOOK_JOB_TYPE))
"""
description = """
If payload serialization fails, error is silently discarded and default
JobSpec created without payload. This masks real problems and causes silent job failures.
"""
tiger_style_principle = "Handle all errors explicitly"
status = "NEEDS_FIX"

[[violations.high]]
id = "HIGH-010"
category = "function_length"
title = "ShellHandler::handle() exceeds 70-line limit (104 lines)"
file = "crates/aspen-hooks/src/handlers.rs"
lines = "221-324"
description = "Shell command execution with timeout handling, process spawning, signal management"
tiger_style_principle = "Keep functions under 70 lines"
status = "NEEDS_FIX"

[[violations.high]]
id = "HIGH-011"
category = "function_length"
title = "decrypt_sops_value() exceeds 70-line limit (88 lines)"
file = "crates/aspen-secrets/src/sops/decryptor.rs"
lines = "247-334"
description = "SOPS value decryption with parsing, base64 decoding, AES-256-GCM decryption"
tiger_style_principle = "Keep functions under 70 lines"
status = "NEEDS_FIX"

# ============================================================================
# MEDIUM PRIORITY VIOLATIONS
# ============================================================================

[[violations.medium]]
id = "MED-001"
category = "error_handling"
title = "Lock poisoning handled with .ok()? in cache"
file = "crates/aspen-client/src/cache.rs"
lines = "68, 77"
code_snippet = """
let entries = self.entries.read().ok()?;
let mut entries = self.entries.write().ok()?;
"""
description = """
Lock poisoning indicates a panic occurred while holding the lock.
Silently returning None instead of propagating or logging.
"""
tiger_style_principle = "Handle all errors; lock poisoning should be logged/handled"
status = "NEEDS_FIX"

[[violations.medium]]
id = "MED-002"
category = "error_handling"
title = "Silent error discarding with .ok() in watch.rs"
file = "crates/aspen-client/src/watch.rs"
lines = "665, 672"
code_snippet = """
timeout(duration, self.event_rx.recv()).await.ok().flatten()
self.event_rx.try_recv().ok()
"""
description = "Timeout errors silently converted to None; cannot distinguish timeout from channel closure"
tiger_style_principle = "Handle errors explicitly to distinguish failure modes"
status = "NEEDS_FIX"

[[violations.medium]]
id = "MED-003"
category = "error_handling"
title = "JSON parsing silent defaults in service registry"
file = "crates/aspen-rpc-handlers/src/handlers/service_registry.rs"
lines = "163, 166"
code_snippet = """
let tags_vec: Vec<String> = serde_json::from_str(&tags).unwrap_or_default();
let custom_map: HashMap<String, String> = serde_json::from_str(&custom_metadata).unwrap_or_default();
"""
description = "Invalid JSON silently becomes empty collections instead of returning error"
tiger_style_principle = "Validate all input; don't silently ignore malformed data"
status = "NEEDS_FIX"

[[violations.medium]]
id = "MED-004"
category = "error_handling"
title = "Request ID generation with silent fallback"
file = "crates/aspen-rpc-handlers/src/client.rs"
line = 186
code_snippet = "seq.next().await.unwrap_or(0)"
description = "Failed request ID generation returns 0, causing ID collisions and breaking tracing"
tiger_style_principle = "Handle errors; don't use 0 as fallback for IDs"
status = "NEEDS_FIX"

[[violations.medium]]
id = "MED-005"
category = "error_handling"
title = "Content discovery signature verification with .ok()?"
file = "crates/aspen-cluster/src/content_discovery.rs"
lines = "332-333"
code_snippet = """
let announce_bytes = self.announce.to_bytes().ok()?;
self.public_key.verify(&announce_bytes, &self.signature).ok()?;
"""
description = "Signature verification errors silently dropped"
tiger_style_principle = "Add error context"
status = "NEEDS_FIX"

[[violations.medium]]
id = "MED-006"
category = "clone_efficiency"
title = "Excessive .clone() calls in bootstrap"
file = "crates/aspen-cluster/src/bootstrap.rs"
lines = "803, 840, 876, 902, 950, 1021, 1032-1035, 1060-1062, etc. (~50+ instances)"
description = "Many Arc::clone() patterns where references could be passed instead"
tiger_style_principle = "Avoid unnecessary .clone()"
status = "NEEDS_FIX"

[[violations.medium]]
id = "MED-007"
category = "error_handling"
title = "Silent error discarding in cob/store hex decode"
file = "crates/aspen-forge/src/cob/store.rs"
lines = "500, 863"
code_snippet = "let bytes = hex::decode(cob_id_hex).ok()?;"
description = "Hex decode errors silently dropped without context"
tiger_style_principle = "Add error context"
status = "NEEDS_FIX"

[[violations.medium]]
id = "MED-008"
category = "clone_efficiency"
title = "WriteCommand clone before match"
file = "crates/aspen-core/src/inmemory.rs"
line = 453
code_snippet = "match request.command.clone() { ... }"
description = "Cloning entire WriteCommand before pattern matching"
tiger_style_principle = "Avoid unnecessary .clone()"
suggested_fix = "Match by reference: match &request.command { ... }"
status = "NEEDS_FIX"

[[violations.medium]]
id = "MED-009"
category = "error_handling"
title = ".ok()? chains in federation discovery"
file = "crates/aspen-cluster/src/federation/discovery.rs"
line = 224
code_snippet = "let origin = PublicKey::from_bytes(&self.fed_id_origin).ok()?;"
description = "PublicKey parsing errors silently dropped"
tiger_style_principle = "Add error context"
status = "NEEDS_FIX"

[[violations.medium]]
id = "MED-010"
category = "type_safety"
title = ".unwrap_or([0; 8]) in numeric index builds"
file = "crates/aspen-layer/src/index.rs"
lines = "226, 237, 250, 258, 274"
code_snippet = "let bytes: [u8; 8] = indexed_value.try_into().unwrap_or([0; 8]);"
description = "Silently uses zeros instead of erroring on invalid numeric index values"
tiger_style_principle = "Validate input; don't use silent fallbacks"
status = "QUESTIONABLE"

[[violations.medium]]
id = "MED-011"
category = "error_handling"
title = "Silenced error in secrets store destroy"
file = "crates/aspen-secrets/src/kv/store.rs"
line = 406
code_snippet = "let _ = self.delete_data(&request.path, *version).await;"
description = "Deletion errors silently ignored during destroy(), could leave inconsistent state"
tiger_style_principle = "Handle errors or log explicitly"
status = "NEEDS_FIX"

# ============================================================================
# LOW PRIORITY VIOLATIONS (Test Code / Style Issues)
# ============================================================================

[[violations.low]]
id = "LOW-001"
category = "test_code"
title = "panic!() instead of assert! in test code (multiple files)"
files = [
    "crates/aspen-forge/src/cob/review.rs",
    "crates/aspen-forge/src/gossip/handler.rs",
    "crates/aspen-client/src/transaction.rs",
    "crates/aspen-client/src/watch.rs",
    "src/bin/git-remote-aspen/protocol.rs",
]
description = "panic!() used in test match arms instead of assert!(matches!())"
tiger_style_principle = "Use assertions over panics even in tests"
status = "NICE_TO_FIX"

[[violations.low]]
id = "LOW-002"
category = "test_code"
title = ".unwrap() in test code"
files = ["Multiple test modules across all crates"]
count = "100+ instances"
description = "Test code uses .unwrap() extensively"
tiger_style_principle = "Model correct patterns even in tests"
status = "NICE_TO_FIX"

[[violations.low]]
id = "LOW-003"
category = "documentation"
title = "TODO comment for incomplete implementation"
file = "crates/aspen-pubsub/src/consumer_group/manager.rs"
line = 228
code_snippet = "// TODO: Also delete pending entries, offsets, and DLQ entries"
description = "Incomplete deletion logic in consumer group manager"
tiger_style_principle = "Complete implementations; track technical debt"
status = "NICE_TO_FIX"

[[violations.low]]
id = "LOW-004"
category = "performance"
title = ".unwrap_or() fallback in aspen-token timestamp"
file = "src/bin/aspen-token.rs"
line = 692
code_snippet = "DateTime::<Utc>::from_timestamp(unix_secs as i64, 0).unwrap_or(DateTime::UNIX_EPOCH)"
description = "Timestamp overflow fallback is silent"
tiger_style_principle = "Log unexpected fallbacks"
status = "NICE_TO_FIX"

# ============================================================================
# POSITIVE FINDINGS (Compliant Patterns)
# ============================================================================

[positive_findings]
description = "Patterns demonstrating excellent Tiger Style compliance"

[[positive_findings.items]]
category = "crate_compliance"
finding = "aspen-raft: Zero production code safety violations"
file = "crates/aspen-raft/src/"
note = """
Exceptionally clean error handling in consensus-critical code.
All .ok() usage is intentional fallback pattern for data recovery.
Proper async/concurrency patterns, no locks held across await.
Pure functions extracted for testability.
"""
score = "98%"

[[positive_findings.items]]
category = "crate_compliance"
finding = "aspen-jobs: 100% Tiger Style compliance"
file = "crates/aspen-jobs/src/"
note = "No violations found in entire crate"
score = "100%"

[[positive_findings.items]]
category = "crate_compliance"
finding = "aspen-pubsub: Near-perfect compliance"
file = "crates/aspen-pubsub/src/"
note = "Only 1 TODO comment found; all code properly structured"
score = "98%"

[[positive_findings.items]]
category = "constants"
finding = "Comprehensive resource limits defined across crates"
files = [
    "crates/aspen-constants/src/lib.rs",
    "crates/aspen-raft/src/constants.rs",
    "crates/aspen-hooks/src/constants.rs",
    "crates/aspen-pubsub/src/constants.rs",
    "crates/aspen-secrets/src/constants.rs",
]
note = """
932+ lines of well-documented Tiger Style constants:
- MAX_KEY_SIZE (1 KB), MAX_VALUE_SIZE (1 MB)
- MAX_BATCH_SIZE (1,000), MAX_SCAN_RESULTS (10,000)
- MAX_RPC_MESSAGE_SIZE (10 MB), MAX_SNAPSHOT_SIZE (100 MB)
- All network operations have explicit timeouts (5-30s)
- MAX_PEERS (64), MAX_CONNECTIONS (500)
"""

[[positive_findings.items]]
category = "error_handling"
finding = "Safe time fallback in utils.rs"
file = "src/utils.rs"
lines = "27, 41"
code_snippet = ".unwrap_or(0) with documented Tiger Style fallback"
note = "Correct pattern: never panic on system time operations"

[[positive_findings.items]]
category = "async_safety"
finding = "Proper tokio::sync primitives usage"
file = "crates/aspen-raft/src/"
note = "No std::sync locks held across await points; uses tokio primitives correctly"

[[positive_findings.items]]
category = "error_types"
finding = "Comprehensive error types with snafu"
files = ["crates/aspen-core/src/error.rs", "crates/aspen-raft/src/error.rs"]
note = "Proper VerbObjectError naming pattern, context propagation"

[[positive_findings.items]]
category = "input_validation"
finding = "Comprehensive input validation in hooks config"
file = "crates/aspen-hooks/src/config.rs"
lines = "154-199"
note = """
Thorough validation of:
- Handler name (non-empty, max length)
- Timeout (enforces max limits)
- Retry count (max limits)
- Pattern length validation
- Duplicate handler detection
"""

[[positive_findings.items]]
category = "bounds_enforcement"
finding = "Proper limits in KV validation"
file = "crates/aspen-core/src/kv.rs"
note = "validate_write_command() enforces all Tiger Style bounds for keys, values, batch sizes"

# ============================================================================
# RECOMMENDATIONS BY PRIORITY
# ============================================================================

[recommendations]

[[recommendations.immediate]]
priority = 1
title = "Fix critical unsafe transmute patterns"
files = ["src/bin/aspen-node.rs", "crates/aspen-cluster/src/bootstrap.rs"]
actions = [
    "Add inline static_assertions for type layout verification",
    "Use transmute_raft_for_transport() helper in aspen-node.rs",
    "Consider safer newtype wrapper alternative",
]

[[recommendations.immediate]]
priority = 2
title = "Fix panic!() in DefaultKvStore::config()"
files = ["crates/aspen-secrets/src/kv/store.rs"]
actions = [
    "Change trait to async method",
    "Or change return type to owned/cloned",
    "Or remove method from trait if unused",
]

[[recommendations.immediate]]
priority = 3
title = "Replace .unwrap() in event bridges"
files = [
    "crates/aspen-cluster/src/docs_bridge.rs",
    "crates/aspen-cluster/src/blob_bridge.rs",
    "crates/aspen-cluster/src/snapshot_events_bridge.rs",
    "crates/aspen-cluster/src/ttl_events_bridge.rs",
    "crates/aspen-cluster/src/system_events_bridge.rs",
    "crates/aspen-cluster/src/hooks_bridge.rs",
]
actions = [
    "Create shared error handling pattern for event deserialization",
    "Replace all .unwrap() with match or map_err",
    "Add tracing for failed deserializations",
    "Replace .unwrap_or_default() with explicit error logging",
]

[[recommendations.high]]
priority = 4
title = "Fix silent .ok()? chains in federation/gossip"
files = [
    "crates/aspen-cluster/src/federation/gossip.rs",
    "crates/aspen-cluster/src/federation/discovery.rs",
    "crates/aspen-cluster/src/content_discovery.rs",
]
actions = [
    "Add .context() to all serialization operations",
    "Log federation announcement failures",
    "Propagate errors instead of silencing",
]

[[recommendations.high]]
priority = 5
title = "Refactor oversized functions"
files = [
    "crates/aspen-rpc-handlers/src/handlers/coordination.rs",
    "crates/aspen-core/src/inmemory.rs",
    "src/bin/aspen-node.rs",
    "crates/aspen-hooks/src/handlers.rs",
    "crates/aspen-secrets/src/sops/decryptor.rs",
]
actions = [
    "Extract handler dispatch into smaller focused functions",
    "Extract write() operation handlers",
    "Create context structs for function parameters",
    "Split shell handler into helper functions",
    "Extract SOPS parsing and decryption helpers",
]

[[recommendations.medium]]
priority = 6
title = "Fix silent error handling patterns"
files = [
    "crates/aspen-client/src/cache.rs",
    "crates/aspen-client/src/watch.rs",
    "crates/aspen-rpc-handlers/src/client.rs",
    "crates/aspen-rpc-handlers/src/handlers/service_registry.rs",
]
actions = [
    "Log lock poisoning before recovering",
    "Distinguish timeout from channel closure in watch",
    "Propagate request ID generation errors",
    "Validate JSON inputs explicitly",
]

[[recommendations.medium]]
priority = 7
title = "Reduce excessive cloning"
files = [
    "crates/aspen-cluster/src/bootstrap.rs",
    "crates/aspen-core/src/inmemory.rs",
]
actions = [
    "Restructure bootstrap to reduce Arc cloning",
    "Match by reference instead of cloning WriteCommand",
]

[[recommendations.nice_to_have]]
priority = 8
title = "Improve test code patterns"
files = ["Various test modules"]
actions = [
    "Replace panic!() with assert_matches!()",
    "Use Result return types in test functions",
    "Add context to .expect() calls in tests",
]

# ============================================================================
# AUDIT METHODOLOGY
# ============================================================================

[methodology]
tools_used = [
    "9 parallel subagent audits for comprehensive coverage",
    "Manual code review",
    "grep/ripgrep pattern matching for .unwrap()/.expect()/panic!/unsafe",
    "Function length analysis",
    "Clone pattern analysis",
    "Cross-referencing between agents",
]
patterns_checked = [
    "Safety: unwrap, expect, panic, todo, unimplemented, unsafe",
    "Type safety: usize in public APIs and constants",
    "Performance: unnecessary clone, unbounded allocations",
    "Function length: >70 lines",
    "Function complexity: >5-6 parameters",
    "Documentation: public items without doc comments",
    "Resource bounds: loops without limits, unbounded collections",
    "Async safety: std locks held across await points",
    "Error handling: .ok() silent discards, missing context",
]
limitations = [
    "Vendored openraft/ directory excluded from audit",
    "Generated code and macros not fully analyzed",
    "Some test code patterns flagged but lower priority",
]

# ============================================================================
# NEXT STEPS
# ============================================================================

[next_steps]
schedule = "Monthly re-audit recommended"
focus_areas = [
    "Track fix progress on critical violations",
    "Re-audit refactored functions for new violations",
    "Add automated CI checks for Tiger Style patterns",
    "Consider clippy lints for .unwrap()/.expect() detection",
]
proposed_ci_checks = [
    "cargo clippy with custom lints for .unwrap()/.expect()",
    "Function length linter",
    "Clone pattern detection",
    "usize in public API detection",
]
