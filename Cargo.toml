[package]
name = "aspen"
version = "0.1.0"
edition = "2024"
license = "Apache-2.0 OR MIT"

[[bin]]
name = "aspen-tui"
path = "src/bin/aspen-tui/main.rs"

[workspace]
members = [".", "scripts/tutorial-verify"]

# Required for vendored openraft workspace inheritance
[workspace.package]
version = "0.10.0"
edition = "2024"
authors = ["Databend Authors <opensource@datafuselabs.com>", "Anthony Dodd <Dodd.AnthonyJosiah@gmail.com>"]
categories = ["algorithms", "asynchronous", "data-structures"]
description = "Advanced Raft consensus"
documentation = "https://docs.rs/openraft"
homepage = "https://github.com/databendlabs/openraft"
keywords = ["raft", "consensus"]
license = "MIT OR Apache-2.0"
repository = "https://github.com/databendlabs/openraft"

# Workspace dependencies for openraft (mirrors openraft/Cargo.toml)
[workspace.dependencies]
anyerror = "0.1.10"
anyhow = "1.0.63"
async-entry = "0.3.1"
byte-unit = "5.1.4"
bytes = "1.0"
chrono = "0.4"
clap = { version = "4.1.11", features = ["derive", "env"] }
derive_more = { version = "1.0", features = ["std", "from", "try_into", "display"] }
futures = "0.3"
lazy_static = "1.4.0"
maplit = "1.0.2"
openraft-macros = { path = "openraft/macros", version = "0.10.0" }
pretty_assertions = "1.0.0"
proc-macro2 = "1.0"
quote = "1.0"
rand = "0.9"
semver = "1.0.14"
serde = { version = "1.0.114", features = ["derive", "rc"] }
serde_json = "1.0.57"
syn = "2.0"
tempfile = "3.4.0"
test-harness = "0.3.0"
thiserror = "1.0.49"
tokio = { version = "1.22", default-features = false, features = ["io-util", "macros", "rt", "rt-multi-thread", "sync", "time"] }
tracing = "0.1.40"
tracing-appender = "0.2.0"
tracing-futures = "0.2.4"
tracing-subscriber = { version = "0.3.3", features = ["env-filter"] }
validit = "0.2.2"

[dependencies]
iroh = { version = "0.95.1", features = ["discovery-local-network", "discovery-pkarr-dht"] }
iroh-base = "0.95.1"
iroh-gossip = "0.95"
iroh-tickets = "0.2"
iroh-relay = "0.95"
iroh-metrics = "0.37"
blake3 = "1.5"
bytes = "1.7"
rand = "0.8"
strum = "0.27"
strum_macros = "0.27"
cryptr = "0.8"
tokio = { version = "1.48.0", features = ["full"] }
tokio-util = { version = "0.7", features = ["compat"] }
anyhow = "1.0"
serde = { version = "1.0", features = ["derive"] }
serde_json = "1.0"
async-trait = "0.1"
tracing = "0.1"
tracing-subscriber = { version = "0.3", features = ["env-filter"] }
clap = { version = "4.5.4", features = ["derive"] }
axum = { version = "0.7", features = ["json"] }
reqwest = { version = "0.12", default-features = false, features = ["json", "rustls-tls"] }
uuid = { version = "1.0", features = ["v4", "serde"] }
chrono = { version = "0.4", features = ["serde"] }
dashmap = "6.1.0"
thiserror = "2.0"
hex = "0.4"
hmac = "0.12"
sha2 = "0.10"
portpicker = "0.1" # Moved from dev-dependencies
bincode = "1.3"
postcard = { version = "1.0", features = ["alloc"] }
openraft = { path = "openraft/openraft", features = ["serde", "type-alias"] }
redb = "2.0.0"
rusqlite = { version = "0.37", features = ["bundled"] }
r2d2 = "0.8"
r2d2_sqlite = "0.31"
snafu = "0.8.9"
irpc = { version = "0.11.0", features = ["derive"] }
madsim = { version = "0.2.34", features = ["macros"] }
mad-turmoil = { git = "https://github.com/s2-streamstore/mad-turmoil", rev = "ef75169ec299c4160af3052b2194b3ee5b048b0a" }
ractor = { version = "0.15.9", features = ["cluster", "async-trait"] }
ractor_cluster = { version = "0.15.9", features = ["async-trait"] }
ractor_actors = { git = "https://github.com/slawlor/ractor_actors", rev = "9a10ec53244767ed025d8b21edbda2bd53c97034", default-features = false, features = ["async-trait"] }
futures = "0.3.31"
toml = "0.8"
libc = "0.2"
parking_lot = "0.12"

# base64 is used by core modules
base64 = "0.22"

# TUI dependencies
ratatui = { version = "0.28", features = ["crossterm"] }
crossterm = { version = "0.28", features = ["event-stream"] }
color-eyre = "0.6"
tui-logger = { version = "0.13", features = ["tracing-support"] }
log = "0.4"
mime = "0.3.17"

[dev-dependencies]
proptest = "1.0"
tokio-test = "0.4"
cargo-nextest = "0.9.60"
tempfile = "3.10"
rand09 = { package = "rand", version = "0.9" }
anyerror = { version = "0.1", features = ["anyhow"] }
criterion = { version = "0.5", features = ["html_reports", "async_tokio"] }

# VM-based integration testing with Cloud Hypervisor
cloud-hypervisor-client = "0.3"

[features]
default = []
testing = []

[lints.rust]
unexpected_cfgs = { level = "warn", check-cfg = ["cfg(madsim)"] }

# Failure scenario tests
[[test]]
name = "test_disk_full_graceful_rejection"
path = "tests/failures/test_disk_full_graceful_rejection.rs"

[[test]]
name = "test_cluster_total_shutdown_recovery"
path = "tests/failures/test_cluster_total_shutdown_recovery.rs"

[[test]]
name = "test_network_split_brain_single_leader"
path = "tests/failures/test_network_split_brain_single_leader.rs"

# Load testing tests
[[test]]
name = "test_sustained_write_load"
path = "tests/load/test_sustained_write_load.rs"

[[test]]
name = "test_concurrent_read_load"
path = "tests/load/test_concurrent_read_load.rs"

[[test]]
name = "test_mixed_workload"
path = "tests/load/test_mixed_workload.rs"

# VM-based integration tests (require root and KVM)
[[test]]
name = "test_vm_basic"
path = "tests/vm/basic_tests.rs"
required-features = ["testing"]

[[test]]
name = "test_vm_partition"
path = "tests/vm/partition_tests.rs"
required-features = ["testing"]

[[test]]
name = "test_vm_failure"
path = "tests/vm/failure_tests.rs"
required-features = ["testing"]

# Benchmarks
[[bench]]
name = "storage_read_concurrency"
path = "benches/storage_read_concurrency.rs"
harness = false
