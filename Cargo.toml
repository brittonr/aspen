[package]
name = "aspen"
version = "0.1.0"
edition = "2024"
license = "GPL-2.0-or-later"
build = "build.rs"

[[bin]]
name = "generate_fuzz_corpus"
path = "src/bin/generate_fuzz_corpus.rs"
required-features = ["fuzzing"]

[[bin]]
name = "git-remote-aspen"
path = "src/bin/git-remote-aspen/main.rs"
required-features = ["git-bridge"]

# CLI moved to crates/aspen-cli
# [[bin]]
# name = "aspen-cli"
# path = "src/bin/aspen-cli/main.rs"

[[example]]
name = "submit_job"
path = "examples/submit_job.rs"

[[example]]
name = "test_vm_standalone"
path = "examples/test_vm_standalone.rs"
required-features = ["vm-executor"]

[workspace]
members = [
    ".",
    "scripts/tutorial-verify",
    "crates/aspen-api",
    "crates/aspen-client",
    "crates/aspen-client-api",
    "crates/aspen-constants",
    "crates/aspen-core",
    "crates/aspen-coordination",
    "crates/aspen-blob",
    "crates/aspen-dns",
    "crates/aspen-layer",
    "crates/aspen-raft-types",
    "crates/aspen-raft",
    "crates/aspen-cluster",
    "crates/aspen-client-rpc",
    "crates/aspen-docs",
    "crates/aspen-testing",
    "crates/aspen-sql",
    "crates/aspen-auth",
    "crates/aspen-sharding",
    "crates/aspen-forge",
    "crates/aspen-pijul",
    "crates/aspen-fuse",
    "crates/aspen-gossip",
    "crates/aspen-jobs",
    "crates/aspen-tui",
    "crates/aspen-transport",
    "crates/aspen-rpc-handlers",
    "crates/aspen-cli",
]

# Required for vendored openraft workspace inheritance
[workspace.package]
version = "0.10.0"
edition = "2024"
authors = ["Databend Authors <opensource@datafuselabs.com>", "Anthony Dodd <Dodd.AnthonyJosiah@gmail.com>"]
categories = ["algorithms", "asynchronous", "data-structures"]
description = "Advanced Raft consensus"
documentation = "https://docs.rs/openraft"
homepage = "https://github.com/databendlabs/openraft"
keywords = ["raft", "consensus"]
license = "MIT OR Apache-2.0"
repository = "https://github.com/databendlabs/openraft"

# Workspace dependencies for openraft (mirrors openraft/Cargo.toml)
# NOTE: These versions are aligned with Aspen's direct dependencies where applicable.
# When updating openraft, re-check these for compatibility.
[workspace.dependencies]
anyerror = "0.1.10"
anyhow = "1.0.63"
async-entry = "0.3.1"
blake3 = "1.5"  # Hash function for content addressing
byte-unit = "5.1.4"
bytes = "1.7"  # Aligned with direct dependency
chrono = "0.4"
clap = { version = "4.5.4", features = ["derive", "env"] }  # Aligned with direct dependency
derive_more = { version = "1.0", features = ["std", "from", "try_into", "display"] }
futures = "0.3"
lazy_static = "1.4.0"
maplit = "1.0.2"
openraft-macros = { path = "openraft/macros", version = "0.10.0" }
pretty_assertions = "1.0.0"
proc-macro2 = "1.0"
quote = "1.0"
rand = "0.9"
semver = "1.0.14"
serde = { version = "1.0", features = ["derive", "rc"] }  # Aligned with direct dependency
serde_json = "1.0"  # Aligned with direct dependency
syn = "2.0"
tempfile = "3.4.0"
test-harness = "0.3.0"
thiserror = "2.0"  # Aligned with direct dependency (major version bump)
tokio = { version = "1.48.0", default-features = false, features = ["io-util", "macros", "rt", "rt-multi-thread", "sync", "time"] }  # Aligned with direct dependency
tracing = "0.1.40"
tracing-appender = "0.2.0"
tracing-futures = "0.2.4"
tracing-subscriber = { version = "0.3", features = ["env-filter"] }  # Aligned with direct dependency
validit = "0.2.2"
aspen-client = { path = "crates/aspen-client" }
aspen-client-api = { path = "crates/aspen-client-api" }
aspen-constants = { path = "crates/aspen-constants" }
aspen-core = { path = "crates/aspen-core" }
aspen-coordination = { path = "crates/aspen-coordination" }
aspen-blob = { path = "crates/aspen-blob" }
aspen-dns = { path = "crates/aspen-dns" }
aspen-layer = { path = "crates/aspen-layer" }
aspen-sql = { path = "crates/aspen-sql" }
aspen-auth = { path = "crates/aspen-auth" }
aspen-sharding = { path = "crates/aspen-sharding" }
aspen-raft-types = { path = "crates/aspen-raft-types" }
aspen-raft = { path = "crates/aspen-raft" }
aspen-cluster = { path = "crates/aspen-cluster" }
aspen-client-rpc = { path = "crates/aspen-client-rpc" }
aspen-docs = { path = "crates/aspen-docs" }
aspen-testing = { path = "crates/aspen-testing" }
aspen-forge = { path = "crates/aspen-forge" }
aspen-pijul = { path = "crates/aspen-pijul" }
aspen-fuse = { path = "crates/aspen-fuse" }
aspen-gossip = { path = "crates/aspen-gossip" }
aspen-tui = { path = "crates/aspen-tui" }
aspen-transport = { path = "crates/aspen-transport" }
aspen-rpc-handlers = { path = "crates/aspen-rpc-handlers" }
aspen-cli = { path = "crates/aspen-cli" }
aspen-api = { path = "crates/aspen-api" }
aspen-jobs = { path = "crates/aspen-jobs" }
irpc = { version = "0.11.0", features = ["derive"] }
postcard = { version = "1.0", features = ["alloc"] }
hmac = "0.12"  # Used by aspen-cluster and aspen-raft
sha2 = "0.10"  # Used by aspen-cluster and aspen-raft
flate2 = "1.0"  # Used by git-remote-aspen and aspen-cli
tar = "0.4"  # Used by aspen-cli for pijul archive

[dependencies]
aspen-api = { workspace = true }
aspen-client = { workspace = true }
aspen-constants = { workspace = true }
aspen-core = { workspace = true, features = ["sql"] }  # global-discovery forwarded via feature
aspen-coordination = { workspace = true }
aspen-blob = { workspace = true }
aspen-layer = { workspace = true }
aspen-sql = { workspace = true, optional = true }
aspen-auth = { workspace = true }
aspen-sharding = { workspace = true }
aspen-raft-types = { workspace = true }
aspen-raft = { workspace = true }
aspen-cluster = { workspace = true }
aspen-client-rpc = { workspace = true }
aspen-dns = { workspace = true, optional = true }
aspen-docs = { workspace = true }
aspen-jobs = { workspace = true }
aspen-transport = { workspace = true }
aspen-rpc-handlers = { workspace = true }
aspen-gossip = { workspace = true }
aspen-forge = { workspace = true, optional = true }
aspen-pijul = { workspace = true, optional = true }
aspen-testing = { workspace = true, optional = true }
# aspen-dns exists as a standalone crate for external consumers
# The main aspen crate uses its own dns module for full integration
iroh = { version = "0.95.1", features = ["discovery-local-network", "discovery-pkarr-dht"] }
iroh-base = "0.95.1"
iroh-gossip = "0.95"
iroh-blobs = "0.97"
iroh-docs = "0.95"
iroh-tickets = "0.2"
blake3 = { workspace = true }
bytes = "1.7"
rand = "0.9"
tokio = { version = "1.48.0", features = ["rt-multi-thread", "macros", "time", "sync", "io-util", "net"] }
tokio-util = { version = "0.7", features = ["compat"] }
anyhow = "1.0"
serde = { version = "1.0", features = ["derive"] }
serde_json = "1.0"
async-trait = "0.1"
tracing = "0.1"
tracing-subscriber = { version = "0.3", features = ["env-filter"] }
clap = { version = "4.5.4", features = ["derive"] }
chrono = { version = "0.4", features = ["serde"] }
env_logger = "0.11"
thiserror = "2.0"
hex = "0.4"
url = "2"
bincode = "1.3"
postcard = { version = "1.0", features = ["alloc"] }
openraft = { path = "openraft/openraft", features = ["serde", "type-alias"] }
redb = "2.0.0"
snafu = "0.8.9"
irpc = { version = "0.11.0", features = ["derive"] }
madsim = { version = "0.2.34", features = ["macros"] }
mad-turmoil = { git = "https://github.com/s2-streamstore/mad-turmoil", rev = "ef75169ec299c4160af3052b2194b3ee5b048b0a" }
futures = "0.3.31"
async-channel = "2.3"
toml = "0.8"
libc = "0.2"
parking_lot = "0.12"

# base64 is used by core modules
base64 = "0.22"

# DataFusion SQL engine (optional, gated by 'sql' feature)
datafusion = { version = "45", default-features = false, features = ["nested_expressions"], optional = true }
arrow = { version = "54", optional = true }
# regex is used for SQL validation when sql feature is enabled
regex = { version = "1.10", optional = true }

# DNS protocol server (optional, gated by 'dns' feature)
hickory-server = { version = "0.25", default-features = false, features = ["resolver"], optional = true }
hickory-resolver = { version = "0.25", default-features = false, features = ["tokio"], optional = true }
hickory-proto = { version = "0.25", optional = true }

# Global content discovery via BitTorrent Mainline DHT (optional)
mainline = { version = "6.0", optional = true, default-features = false, features = ["async"] }

# Git bridge zlib compression (optional, gated by 'git-bridge' feature)
flate2 = { workspace = true, optional = true }

# TUI is now a separate crate: aspen-tui
# FUSE filesystem is now a separate crate: aspen-fuse

[dev-dependencies]
aspen-testing = { workspace = true, features = ["sql"] }
# Property-based testing with Bolero (unified frontend for multiple backends)
bolero = "0.13"
bolero-generator = "0.13"
# Keep proptest for madsim compatibility (madsim tests use proptest strategies internally)
proptest = "1.0"

tokio-test = "0.4"
cargo-nextest = "0.9.60"
tempfile = "3.10"
# rand09 alias removed - now using rand 0.9 directly
anyerror = { version = "0.1", features = ["anyhow"] }
criterion = { version = "0.5", features = ["html_reports", "async_tokio"] }
portpicker = "0.1"

# VM-based integration testing with Cloud Hypervisor
cloud-hypervisor-client = "0.3"

[features]
default = ["sql", "dns", "forge", "vm-executor"]
testing = ["dep:aspen-testing"]
# Forge: Git on Aspen - decentralized code collaboration with Radicle-like features
forge = ["dep:aspen-forge"]
# Git bridge: bidirectional sync with standard Git repositories (GitHub, GitLab, Gitea, etc.)
git-bridge = ["forge", "aspen-forge/git-bridge", "dep:flate2"]
# DataFusion SQL query engine for Redb storage backend
sql = ["dep:aspen-sql", "dep:datafusion", "dep:arrow", "dep:regex"]
# DNS record management layer with hickory-server protocol support
dns = ["dep:aspen-dns", "dep:hickory-server", "dep:hickory-resolver", "dep:hickory-proto"]
# VM-based job execution with Hyperlight
vm-executor = ["aspen-jobs/vm-executor"]
# TUI is now a separate crate: aspen-tui (see crates/aspen-tui)
# Fuzzing feature exposes internals for fuzz testing
fuzzing = []
# Bolero property-based testing (for dev/CI, uses bolero dev-dependency)
bolero = []
# FUSE filesystem is now a separate crate: aspen-fuse
# Global content discovery via BitTorrent Mainline DHT
global-discovery = ["dep:mainline", "aspen-core/global-discovery", "aspen-rpc-handlers/global-discovery"]
# Pijul native VCS - patch-based distributed version control (GPL-2.0-or-later)
pijul = ["forge", "dep:aspen-pijul"]

[lints.rust]
unexpected_cfgs = { level = "warn", check-cfg = ["cfg(madsim)", "cfg(feature, values(\"sql\", \"dns\", \"forge\", \"git-bridge\", \"pijul\", \"global-discovery\", \"testing\", \"fuzzing\", \"bolero\", \"vm-executor\"))"] }

[lints.clippy]
# Allow certain patterns in tests that are flagged during pre-commit
unnecessary_to_owned = "allow"
needless_borrow = "allow"

# Benchmarks
[[bench]]
name = "kv_operations"
harness = false
required-features = ["testing"]

[[bench]]
name = "workloads"
harness = false
required-features = ["testing"]

[[bench]]
name = "concurrency"
harness = false
required-features = ["testing"]

[[bench]]
name = "production"
harness = false
required-features = ["testing"]

[[bench]]
name = "sql"
harness = false
required-features = ["testing"]

[[bench]]
name = "write_batching"
harness = false
required-features = ["testing"]
